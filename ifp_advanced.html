
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>58. The Income Fluctuation Problem II: Stochastic Returns on Assets &#8212; Intermediate Quantitative Economics with Python</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/quantecon-book-theme.css?digest=15c2afa29682abb9326a76db12ed4f4c791e68c4" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css?v=982b99e0" />
    <link rel="stylesheet" type="text/css" href="_static/proof.css?v=4c010e0d" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>


    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="_static/scripts/quantecon-book-theme.js?digest=06ebc90d5139b434c2742937a4ef3b185cb93e2f"></script>
    <script src="_static/scripts/jquery.js?v=5d32c60e"></script>
    <script src="_static/scripts/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-J0SMYR4SG3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-J0SMYR4SG3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-J0SMYR4SG3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ifp_advanced';</script>
    <link rel="canonical" href="https://python.quantecon.org/ifp_advanced.html" />
    <link rel="icon" href="_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="59. LQ Control: Foundations" href="lqcontrol.html" />
    <link rel="prev" title="57. The Income Fluctuation Problem I: Basic Model" href="ifp.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Python, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="The Income Fluctuation Problem II: Stochastic Returns on Assets"/>
<meta name="twitter:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="The Income Fluctuation Problem II: Stochastic Returns on Assets" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://python.quantecon.org/ifp_advanced.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski." />
<meta property="og:site_name" content="Intermediate Quantitative Economics with Python" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>

<!-- Override QuantEcon theme colors -->

    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=ifp_advanced>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">58.1. Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-savings-problem">58.2. The Savings Problem</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">58.2.1. Set Up</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions">58.2.2. Assumptions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimality">58.2.3. Optimality</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-algorithm">58.3. Solution Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-time-iteration-operator">58.3.1. A Time Iteration Operator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-properties">58.3.2. Convergence Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-an-endogenous-grid">58.3.3. Using an Endogenous Grid</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-optimal-consumption">58.3.3.1. Finding Optimal Consumption</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#iterating">58.3.3.2. Iterating</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-assumptions">58.3.4. Testing the Assumptions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numba-implementation">58.4. Numba Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-details">58.4.1. Implementation Details</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-walkthrough">58.4.2. Code Walkthrough</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#law-of-motion">58.4.3. Law of Motion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-implementation">58.5. JAX Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-numba-and-jax-solutions">58.5.1. Comparison of Numba and JAX Solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">58.6. Exercises</a></li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="_static/qe-logo-large.png" class="logo logo-img" alt="logo"></a>
                                    
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/en/stable/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="intro.html">Intermediate Quantitative Economics with Python</a></p>

                        <p class="qe-page__header-subheading">The Income Fluctuation Problem II: Stochastic Returns on Assets</p>

                    </div>
                    <!-- length 2, since its a string and empty dict has length 2 - {} -->
                        <p class="qe-page__header-authors" font-size="18">
                            
                                
                                    <a href="http://www.tomsargent.com/" target="_blank"><span>Thomas J. Sargent</span></a>
                                
                            
                                
                                    and <a href="https://johnstachurski.net/" target="_blank"><span>John Stachurski</span></a>
                                
                            
                        </p>


                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <section class="tex2jax_ignore mathjax_ignore" id="the-income-fluctuation-problem-ii-stochastic-returns-on-assets">
<h1><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">58. </span><span class="target" id="index-0"></span>The Income Fluctuation Problem II: Stochastic Returns on Assets</a><a class="headerlink" href="#the-income-fluctuation-problem-ii-stochastic-returns-on-assets" title="Link to this heading">#</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#the-income-fluctuation-problem-ii-stochastic-returns-on-assets" id="id9">The Income Fluctuation Problem II: Stochastic Returns on Assets</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id10">Overview</a></p></li>
<li><p><a class="reference internal" href="#the-savings-problem" id="id11">The Savings Problem</a></p></li>
<li><p><a class="reference internal" href="#solution-algorithm" id="id12">Solution Algorithm</a></p></li>
<li><p><a class="reference internal" href="#numba-implementation" id="id13">Numba Implementation</a></p></li>
<li><p><a class="reference internal" href="#jax-implementation" id="id14">JAX Implementation</a></p></li>
<li><p><a class="reference internal" href="#exercises" id="id15">Exercises</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>In addition to what’s in Anaconda, this lecture will need the following libraries:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>quantecon
</pre></div>
</div>
</div>
<details class="admonition hide below-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell output</p>
<p class="expanded admonition-title">Hide code cell output</p>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: quantecon in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (0.10.1)
Requirement already satisfied: numba&gt;=0.49.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (0.61.0)
Requirement already satisfied: numpy&gt;=1.17.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.1.3)
Requirement already satisfied: requests in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.32.3)
Requirement already satisfied: scipy&gt;=1.5.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.15.3)
Requirement already satisfied: sympy in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.13.3)
Requirement already satisfied: llvmlite&lt;0.45,&gt;=0.44.0dev0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from numba&gt;=0.49.0-&gt;quantecon) (0.44.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.7)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2.3.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2025.4.26)
Requirement already satisfied: mpmath&lt;1.4,&gt;=1.1.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from sympy-&gt;quantecon) (1.3.0)
</pre></div>
</div>
</div>
</details>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">58.1. </span>Overview</a><a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>In this lecture, we continue our study of the <a class="reference internal" href="ifp.html"><span class="doc">income fluctuation problem</span></a>.</p>
<p>While the interest rate was previously taken to be fixed, we now allow
returns on assets to be state-dependent.</p>
<p>This matches the fact that most households with a positive level of assets
face some capital income risk.</p>
<p>It has been argued that modeling capital income risk is essential for
understanding the joint distribution of income and wealth (see, e.g.,
<span id="id1">[<a class="reference internal" href="zreferences.html#id148" title="Jess Benhabib, Alberto Bisin, and Shenghao Zhu. The wealth distribution in bewley economies with capital income risk. Journal of Economic Theory, 159:489–515, 2015.">Benhabib <em>et al.</em>, 2015</a>]</span> or <span id="id2">[<a class="reference internal" href="zreferences.html#id271" title="John Stachurski and Alexis Akira Toda. An impossibility theorem for wealth in heterogeneous-agent models with limited heterogeneity. Journal of Economic Theory, 182:1–24, 2019.">Stachurski and Toda, 2019</a>]</span>).</p>
<p>Theoretical properties of the household savings model presented here are
analyzed in detail in <span id="id3">[<a class="reference internal" href="zreferences.html#id270" title="Qingyin Ma, John Stachurski, and Alexis Akira Toda. The income fluctuation problem and the evolution of wealth. Journal of Economic Theory, 187:105003, 2020.">Ma <em>et al.</em>, 2020</a>]</span>.</p>
<p>In terms of computation, we use a combination of time iteration and the
endogenous grid method to solve the model quickly and accurately.</p>
<p>We require the following imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">float64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.experimental</span><span class="w"> </span><span class="kn">import</span> <span class="n">jitclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkovChain</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-savings-problem">
<h2><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">58.2. </span>The Savings Problem</a><a class="headerlink" href="#the-savings-problem" title="Link to this heading">#</a></h2>
<p>In this section we review the household problem and optimality results.</p>
<section id="set-up">
<h3><span class="section-number">58.2.1. </span>Set Up<a class="headerlink" href="#set-up" title="Link to this heading">#</a></h3>
<p>A household chooses a consumption-asset path <span class="math notranslate nohighlight">\(\{(c_t, a_t)\}\)</span> to
maximize</p>
<div class="math notranslate nohighlight" id="equation-trans-at">
<span class="eqno">(58.1)<a class="headerlink" href="#equation-trans-at" title="Link to this equation">#</a></span>\[\mathbb E \left\{ \sum_{t=0}^\infty \beta^t u(c_t) \right\}\]</div>
<p>subject to</p>
<div class="math notranslate nohighlight" id="equation-trans-at2">
<span class="eqno">(58.2)<a class="headerlink" href="#equation-trans-at2" title="Link to this equation">#</a></span>\[a_{t+1} = R_{t+1} (a_t - c_t) + Y_{t+1}
\; \text{ and } \;
0 \leq c_t \leq a_t,\]</div>
<p>with initial condition <span class="math notranslate nohighlight">\((a_0, Z_0)=(a,z)\)</span> treated as given.</p>
<p>Note that <span class="math notranslate nohighlight">\(\{R_t\}_{t \geq 1}\)</span>, the gross rate of return on wealth, is allowed to be stochastic.</p>
<p>The sequence <span class="math notranslate nohighlight">\(\{Y_t \}_{t \geq 1}\)</span> is non-financial income.</p>
<p>The stochastic components of the problem obey</p>
<div class="math notranslate nohighlight" id="equation-eq-ry-func">
<span class="eqno">(58.3)<a class="headerlink" href="#equation-eq-ry-func" title="Link to this equation">#</a></span>\[R_t = R(Z_t, \zeta_t)
  \quad \text{and} \quad
Y_t = Y(Z_t, \eta_t),\]</div>
<p>where</p>
<ul class="simple">
<li><p>the maps <span class="math notranslate nohighlight">\(R\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> are time-invariant nonnegative functions,</p></li>
<li><p>the innovation processes <span class="math notranslate nohighlight">\(\{\zeta_t\}\)</span> and
<span class="math notranslate nohighlight">\(\{\eta_t\}\)</span> are IID and independent of each other, and</p></li>
<li><p><span class="math notranslate nohighlight">\(\{Z_t\}_{t \geq 0}\)</span> is an irreducible time-homogeneous Markov chain on a finite set <span class="math notranslate nohighlight">\(\mathsf Z\)</span></p></li>
</ul>
<p>Let <span class="math notranslate nohighlight">\(P\)</span> represent the Markov matrix for the chain <span class="math notranslate nohighlight">\(\{Z_t\}_{t \geq 0}\)</span>.</p>
<p>Our assumptions on preferences are the same as our <a class="reference internal" href="ifp.html"><span class="doc">previous lecture</span></a> on the income fluctuation problem.</p>
<p>As before, <span class="math notranslate nohighlight">\(\mathbb E_z \hat X\)</span> means expectation of next period value
<span class="math notranslate nohighlight">\(\hat X\)</span> given current value <span class="math notranslate nohighlight">\(Z = z\)</span>.</p>
</section>
<section id="assumptions">
<h3><span class="section-number">58.2.2. </span>Assumptions<a class="headerlink" href="#assumptions" title="Link to this heading">#</a></h3>
<p>We need restrictions to ensure that the objective <a class="reference internal" href="#equation-trans-at">(58.1)</a> is finite and
the solution methods described below converge.</p>
<p>We also need to ensure that the present discounted value of wealth
does not grow too quickly.</p>
<p>When <span class="math notranslate nohighlight">\(\{R_t\}\)</span> was constant we required that <span class="math notranslate nohighlight">\(\beta R &lt; 1\)</span>.</p>
<p>Since it is now stochastic, we require that</p>
<div class="math notranslate nohighlight" id="equation-fpbc2">
<span class="eqno">(58.4)<a class="headerlink" href="#equation-fpbc2" title="Link to this equation">#</a></span>\[\beta G_R &lt; 1,
\quad \text{where} \quad
G_R := \lim_{n \to \infty}
\left(\mathbb E \prod_{t=1}^n R_t \right)^{1/n}\]</div>
<p>Notice that, when <span class="math notranslate nohighlight">\(\{R_t\}\)</span> takes some constant value <span class="math notranslate nohighlight">\(R\)</span>, this
reduces to the previous restriction <span class="math notranslate nohighlight">\(\beta R &lt; 1\)</span>.</p>
<p>The value <span class="math notranslate nohighlight">\(G_R\)</span> can be thought of as the long run (geometric) average
gross rate of return.</p>
<p>More intuition behind <a class="reference internal" href="#equation-fpbc2">(58.4)</a> is provided in <span id="id4">[<a class="reference internal" href="zreferences.html#id270" title="Qingyin Ma, John Stachurski, and Alexis Akira Toda. The income fluctuation problem and the evolution of wealth. Journal of Economic Theory, 187:105003, 2020.">Ma <em>et al.</em>, 2020</a>]</span>.</p>
<p>Discussion on how to check it is given below.</p>
<p>Finally, we impose some routine technical restrictions on non-financial income.</p>
<div class="math notranslate nohighlight">
\[
\mathbb E \, Y_t &lt; \infty \text{ and } \mathbb E \, u'(Y_t) &lt; \infty
\label{a:y0}
\]</div>
<p>One relatively simple setting where all these restrictions are satisfied is
the IID and CRRA environment of <span id="id5">[<a class="reference internal" href="zreferences.html#id148" title="Jess Benhabib, Alberto Bisin, and Shenghao Zhu. The wealth distribution in bewley economies with capital income risk. Journal of Economic Theory, 159:489–515, 2015.">Benhabib <em>et al.</em>, 2015</a>]</span>.</p>
</section>
<section id="optimality">
<h3><span class="section-number">58.2.3. </span>Optimality<a class="headerlink" href="#optimality" title="Link to this heading">#</a></h3>
<p>Let the class of candidate consumption policies <span class="math notranslate nohighlight">\(\mathscr C\)</span> be defined
<a class="reference internal" href="ifp.html"><span class="doc">as before</span></a>.</p>
<p>In <span id="id6">[<a class="reference internal" href="zreferences.html#id270" title="Qingyin Ma, John Stachurski, and Alexis Akira Toda. The income fluctuation problem and the evolution of wealth. Journal of Economic Theory, 187:105003, 2020.">Ma <em>et al.</em>, 2020</a>]</span> it is shown that, under the stated assumptions,</p>
<ul class="simple">
<li><p>any <span class="math notranslate nohighlight">\(\sigma \in \mathscr C\)</span> satisfying the Euler equation is an
optimal policy and</p></li>
<li><p>exactly one such policy exists in <span class="math notranslate nohighlight">\(\mathscr C\)</span>.</p></li>
</ul>
<p>In the present setting, the Euler equation takes the form</p>
<div class="math notranslate nohighlight" id="equation-ifpa-euler">
<span class="eqno">(58.5)<a class="headerlink" href="#equation-ifpa-euler" title="Link to this equation">#</a></span>\[(u' \circ \sigma) (a, z) =
\max \left\{
           \beta \, \mathbb E_z \,\hat{R} \,
             (u' \circ \sigma)[\hat{R}(a - \sigma(a, z)) + \hat{Y}, \, \hat{Z}],
          \, u'(a)
       \right\}\]</div>
<p>(Intuition and derivation are similar to our <a class="reference internal" href="ifp.html"><span class="doc">earlier lecture</span></a> on
the income fluctuation problem.)</p>
<p>We again solve the Euler equation using time iteration, iterating with a
Coleman–Reffett operator <span class="math notranslate nohighlight">\(K\)</span> defined to match the Euler equation
<a class="reference internal" href="#equation-ifpa-euler">(58.5)</a>.</p>
</section>
</section>
<section id="solution-algorithm">
<h2><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">58.3. </span>Solution Algorithm</a><a class="headerlink" href="#solution-algorithm" title="Link to this heading">#</a></h2>
<section id="a-time-iteration-operator">
<span id="index-1"></span><h3><span class="section-number">58.3.1. </span>A Time Iteration Operator<a class="headerlink" href="#a-time-iteration-operator" title="Link to this heading">#</a></h3>
<p>Our definition of the candidate class <span class="math notranslate nohighlight">\(\sigma \in \mathscr C\)</span> of consumption
policies is the same as in our <a class="reference internal" href="ifp.html"><span class="doc">earlier lecture</span></a> on the income
fluctuation problem.</p>
<p>For fixed <span class="math notranslate nohighlight">\(\sigma \in \mathscr C\)</span> and <span class="math notranslate nohighlight">\((a,z) \in \mathbf S\)</span>, the value
<span class="math notranslate nohighlight">\(K\sigma(a,z)\)</span> of the function <span class="math notranslate nohighlight">\(K\sigma\)</span> at <span class="math notranslate nohighlight">\((a,z)\)</span> is defined as the
<span class="math notranslate nohighlight">\(\xi \in (0,a]\)</span> that solves</p>
<div class="math notranslate nohighlight" id="equation-k-opr">
<span class="eqno">(58.6)<a class="headerlink" href="#equation-k-opr" title="Link to this equation">#</a></span>\[u'(\xi) =
\max \left\{
          \beta \, \mathbb E_z \, \hat{R} \,
             (u' \circ \sigma)[\hat{R}(a - \xi) + \hat{Y}, \, \hat{Z}],
          \, u'(a)
       \right\}\]</div>
<p>The idea behind <span class="math notranslate nohighlight">\(K\)</span> is that, as can be seen from the definitions,
<span class="math notranslate nohighlight">\(\sigma \in \mathscr C\)</span> satisfies the Euler equation
if and only if <span class="math notranslate nohighlight">\(K\sigma(a, z) = \sigma(a, z)\)</span> for all <span class="math notranslate nohighlight">\((a, z) \in
\mathbf S\)</span>.</p>
<p>This means that fixed points of <span class="math notranslate nohighlight">\(K\)</span> in <span class="math notranslate nohighlight">\(\mathscr C\)</span> and optimal
consumption policies exactly coincide (see <span id="id7">[<a class="reference internal" href="zreferences.html#id270" title="Qingyin Ma, John Stachurski, and Alexis Akira Toda. The income fluctuation problem and the evolution of wealth. Journal of Economic Theory, 187:105003, 2020.">Ma <em>et al.</em>, 2020</a>]</span> for more details).</p>
</section>
<section id="convergence-properties">
<h3><span class="section-number">58.3.2. </span>Convergence Properties<a class="headerlink" href="#convergence-properties" title="Link to this heading">#</a></h3>
<p>As before, we pair <span class="math notranslate nohighlight">\(\mathscr C\)</span> with the distance</p>
<div class="math notranslate nohighlight">
\[
\rho(c,d)
:= \sup_{(a,z) \in \mathbf S}
          \left|
              \left(u' \circ c \right)(a,z) -
              \left(u' \circ d \right)(a,z)
          \right|,
\]</div>
<p>It can be shown that</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\((\mathscr C, \rho)\)</span> is a complete metric space,</p></li>
<li><p>there exists an integer <span class="math notranslate nohighlight">\(n\)</span> such that <span class="math notranslate nohighlight">\(K^n\)</span> is a contraction
mapping on <span class="math notranslate nohighlight">\((\mathscr C, \rho)\)</span>, and</p></li>
<li><p>The unique fixed point of <span class="math notranslate nohighlight">\(K\)</span> in <span class="math notranslate nohighlight">\(\mathscr C\)</span> is
the unique optimal policy in <span class="math notranslate nohighlight">\(\mathscr C\)</span>.</p></li>
</ol>
<p>We now have a clear path to successfully approximating the optimal policy:
choose some <span class="math notranslate nohighlight">\(\sigma \in \mathscr C\)</span> and then iterate with <span class="math notranslate nohighlight">\(K\)</span> until
convergence (as measured by the distance <span class="math notranslate nohighlight">\(\rho\)</span>).</p>
</section>
<section id="using-an-endogenous-grid">
<h3><span class="section-number">58.3.3. </span>Using an Endogenous Grid<a class="headerlink" href="#using-an-endogenous-grid" title="Link to this heading">#</a></h3>
<p>In the study of that model we found that it was possible to further
accelerate time iteration via the <a class="reference internal" href="cake_eating_egm.html"><span class="doc">endogenous grid method</span></a>.</p>
<p>We will use the same method here.</p>
<p>The methodology is the same as it was for the optimal growth model, with the
minor exception that we need to remember that consumption is not always
interior.</p>
<p>In particular, optimal consumption can be equal to assets when the level of
assets is low.</p>
<section id="finding-optimal-consumption">
<h4><span class="section-number">58.3.3.1. </span>Finding Optimal Consumption<a class="headerlink" href="#finding-optimal-consumption" title="Link to this heading">#</a></h4>
<p>The endogenous grid method (EGM) calls for us to take a grid of <em>savings</em>
values <span class="math notranslate nohighlight">\(s_i\)</span>, where each such <span class="math notranslate nohighlight">\(s\)</span> is interpreted as <span class="math notranslate nohighlight">\(s = a -
c\)</span>.</p>
<p>For the lowest grid point we take <span class="math notranslate nohighlight">\(s_0 = 0\)</span>.</p>
<p>For the corresponding <span class="math notranslate nohighlight">\(a_0, c_0\)</span> pair we have <span class="math notranslate nohighlight">\(a_0 = c_0\)</span>.</p>
<p>This happens close to the origin, where assets are low and the household
consumes all that it can.</p>
<p>Although there are many solutions, the one we take is <span class="math notranslate nohighlight">\(a_0 = c_0 = 0\)</span>,
which pins down the policy at the origin, aiding interpolation.</p>
<p>For <span class="math notranslate nohighlight">\(s &gt; 0\)</span>, we have, by definition, <span class="math notranslate nohighlight">\(c &lt; a\)</span>, and hence
consumption is interior.</p>
<p>Hence the max component of <a class="reference internal" href="#equation-ifpa-euler">(58.5)</a> drops out, and we solve for</p>
<div class="math notranslate nohighlight" id="equation-eqsifc2">
<span class="eqno">(58.7)<a class="headerlink" href="#equation-eqsifc2" title="Link to this equation">#</a></span>\[c_i =
(u')^{-1}
\left\{
    \beta \, \mathbb E_z
    \hat R
    (u' \circ \sigma) \, [\hat R s_i + \hat Y, \, \hat Z]
\right\}\]</div>
<p>at each <span class="math notranslate nohighlight">\(s_i\)</span>.</p>
</section>
<section id="iterating">
<h4><span class="section-number">58.3.3.2. </span>Iterating<a class="headerlink" href="#iterating" title="Link to this heading">#</a></h4>
<p>Once we have the pairs <span class="math notranslate nohighlight">\(\{s_i, c_i\}\)</span>, the endogenous asset grid is
obtained by <span class="math notranslate nohighlight">\(a_i = c_i + s_i\)</span>.</p>
<p>Also, we held <span class="math notranslate nohighlight">\(z \in \mathsf Z\)</span> in the discussion above so we can pair
it with <span class="math notranslate nohighlight">\(a_i\)</span>.</p>
<p>An approximation of the policy <span class="math notranslate nohighlight">\((a, z) \mapsto \sigma(a, z)\)</span> can be
obtained by interpolating <span class="math notranslate nohighlight">\(\{a_i, c_i\}\)</span> at each <span class="math notranslate nohighlight">\(z\)</span>.</p>
<p>In what follows, we use linear interpolation.</p>
</section>
</section>
<section id="testing-the-assumptions">
<h3><span class="section-number">58.3.4. </span>Testing the Assumptions<a class="headerlink" href="#testing-the-assumptions" title="Link to this heading">#</a></h3>
<p>Convergence of time iteration is dependent on the condition <span class="math notranslate nohighlight">\(\beta G_R &lt; 1\)</span> being satisfied.</p>
<p>One can check this using the fact that <span class="math notranslate nohighlight">\(G_R\)</span> is equal to the spectral
radius of the matrix <span class="math notranslate nohighlight">\(L\)</span> defined by</p>
<div class="math notranslate nohighlight">
\[
L(z, \hat z) := P(z, \hat z) \int R(\hat z, x) \phi(x) dx
\]</div>
<p>This identity is proved in <span id="id8">[<a class="reference internal" href="zreferences.html#id270" title="Qingyin Ma, John Stachurski, and Alexis Akira Toda. The income fluctuation problem and the evolution of wealth. Journal of Economic Theory, 187:105003, 2020.">Ma <em>et al.</em>, 2020</a>]</span>, where <span class="math notranslate nohighlight">\(\phi\)</span> is the
density of the innovation <span class="math notranslate nohighlight">\(\zeta_t\)</span> to returns on assets.</p>
<p>(Remember that <span class="math notranslate nohighlight">\(\mathsf Z\)</span> is a finite set, so this expression defines a matrix.)</p>
<p>Checking the condition is even easier when <span class="math notranslate nohighlight">\(\{R_t\}\)</span> is IID.</p>
<p>In that case, it is clear from the definition of <span class="math notranslate nohighlight">\(G_R\)</span> that <span class="math notranslate nohighlight">\(G_R\)</span>
is just <span class="math notranslate nohighlight">\(\mathbb E R_t\)</span>.</p>
<p>We test the condition <span class="math notranslate nohighlight">\(\beta \mathbb E R_t &lt; 1\)</span> in the code below.</p>
</section>
</section>
<section id="numba-implementation">
<h2><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">58.4. </span>Numba Implementation</a><a class="headerlink" href="#numba-implementation" title="Link to this heading">#</a></h2>
<p>We will assume that <span class="math notranslate nohighlight">\(R_t = \exp(a_r \zeta_t + b_r)\)</span> where <span class="math notranslate nohighlight">\(a_r, b_r\)</span>
are constants and <span class="math notranslate nohighlight">\(\{ \zeta_t\}\)</span> is IID standard normal.</p>
<p>We allow labor income to be correlated, with</p>
<div class="math notranslate nohighlight">
\[
Y_t = \exp(a_y \eta_t + Z_t b_y)
\]</div>
<p>where <span class="math notranslate nohighlight">\(\{ \eta_t\}\)</span> is also IID standard normal
and <span class="math notranslate nohighlight">\(\{ Z_t\}\)</span> is a Markov chain taking values in <span class="math notranslate nohighlight">\(\{0, 1\}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ifp_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;γ&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>              <span class="c1"># utility parameter</span>
    <span class="p">(</span><span class="s1">&#39;β&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>              <span class="c1"># discount factor</span>
    <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">[:,</span> <span class="p">:]),</span>        <span class="c1"># transition probs for z_t</span>
    <span class="p">(</span><span class="s1">&#39;a_r&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>            <span class="c1"># scale parameter for R_t</span>
    <span class="p">(</span><span class="s1">&#39;b_r&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>            <span class="c1"># additive parameter for R_t</span>
    <span class="p">(</span><span class="s1">&#39;a_y&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>            <span class="c1"># scale parameter for Y_t</span>
    <span class="p">(</span><span class="s1">&#39;b_y&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>            <span class="c1"># additive parameter for Y_t</span>
    <span class="p">(</span><span class="s1">&#39;s_grid&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">[:]),</span>      <span class="c1"># Grid over savings</span>
    <span class="p">(</span><span class="s1">&#39;η_draws&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">[:]),</span>     <span class="c1"># Draws of innovation η for MC</span>
    <span class="p">(</span><span class="s1">&#39;ζ_draws&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">[:])</span>      <span class="c1"># Draws of innovation ζ for MC</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jitclass</span><span class="p">(</span><span class="n">ifp_data</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IFP</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that stores primitives for the income fluctuation</span>
<span class="sd">    problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">γ</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">β</span><span class="o">=</span><span class="mf">0.96</span><span class="p">,</span>
                 <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                             <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)]),</span>
                 <span class="n">a_r</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">b_r</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">a_y</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                 <span class="n">b_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">shock_draw_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                 <span class="n">grid_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">grid_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># arbitrary seed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">γ</span><span class="p">,</span> <span class="n">β</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_y</span> <span class="o">=</span> <span class="n">a_r</span><span class="p">,</span> <span class="n">b_r</span><span class="p">,</span> <span class="n">a_y</span><span class="p">,</span> <span class="n">b_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">η_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shock_draw_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ζ_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shock_draw_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_max</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">)</span>

        <span class="c1"># Test stability assuming {R_t} is IID and adopts the lognormal</span>
        <span class="c1"># specification given below.  The test is then β E R_t &lt; 1.</span>
        <span class="n">ER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b_r</span> <span class="o">+</span> <span class="n">a_r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">β</span> <span class="o">*</span> <span class="n">ER</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Stability condition failed.&quot;</span>

    <span class="c1"># Marginal utility</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">u_prime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span>

    <span class="c1"># Inverse of marginal utility</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">u_prime_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">R</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ζ</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_r</span> <span class="o">*</span> <span class="n">ζ</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_r</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">η</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_y</span> <span class="o">*</span> <span class="n">η</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the Coleman-Reffett operator based on EGM:</p>
<section id="implementation-details">
<h3><span class="section-number">58.4.1. </span>Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">#</a></h3>
<p>The implementation of operator <span class="math notranslate nohighlight">\(K\)</span> maps directly to equation <a class="reference internal" href="#equation-k-opr">(58.6)</a>.</p>
<p>The left side <span class="math notranslate nohighlight">\(u'(\xi)\)</span> becomes <code class="docutils literal notranslate"><span class="pre">u_prime_inv(β</span> <span class="pre">*</span> <span class="pre">Ez)</span></code> after solving for <span class="math notranslate nohighlight">\(\xi\)</span>.</p>
<p>The expectation term <span class="math notranslate nohighlight">\(\mathbb E_z \hat{R} (u' \circ \sigma)[\hat{R}(a - \xi) + \hat{Y}, \hat{Z}]\)</span> is computed via Monte Carlo averaging over future states and shocks.</p>
<p>The max with <span class="math notranslate nohighlight">\(u'(a)\)</span> is handled implicitly—the endogenous grid method naturally handles the liquidity constraint since we only solve for interior consumption where <span class="math notranslate nohighlight">\(c &lt; a\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">K</span><span class="p">(</span><span class="n">ae_vals</span><span class="p">,</span> <span class="n">c_vals</span><span class="p">,</span> <span class="n">ifp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Coleman--Reffett operator for the income fluctuation problem,</span>
<span class="sd">    using the endogenous grid method.</span>

<span class="sd">        * ifp is an instance of IFP</span>
<span class="sd">        * ae_vals[i, z] is an asset grid</span>
<span class="sd">        * c_vals[i, z] is consumption at ae_vals[i, z]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Simplify names</span>
    <span class="n">u_prime</span><span class="p">,</span> <span class="n">u_prime_inv</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">u_prime</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">u_prime_inv</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">β</span>
    <span class="n">s_grid</span><span class="p">,</span> <span class="n">η_draws</span><span class="p">,</span> <span class="n">ζ_draws</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">s_grid</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">η_draws</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">ζ_draws</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="c1"># Create consumption function by linear interpolation</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ae_vals</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">c_vals</span><span class="p">[:,</span> <span class="n">z</span><span class="p">])</span>

    <span class="c1"># Allocate memory</span>
    <span class="n">c_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">c_vals</span><span class="p">)</span>

    <span class="c1"># Obtain c_i at each s_i, z, store in c_out[i, z], computing</span>
    <span class="c1"># the expectation term by Monte Carlo</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_grid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># Compute expectation</span>
            <span class="n">Ez</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">z_hat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">η</span> <span class="ow">in</span> <span class="n">ifp</span><span class="o">.</span><span class="n">η_draws</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ζ</span> <span class="ow">in</span> <span class="n">ifp</span><span class="o">.</span><span class="n">ζ_draws</span><span class="p">:</span>
                        <span class="n">R_hat</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">z_hat</span><span class="p">,</span> <span class="n">ζ</span><span class="p">)</span>
                        <span class="n">Y_hat</span> <span class="o">=</span> <span class="n">Y</span><span class="p">(</span><span class="n">z_hat</span><span class="p">,</span> <span class="n">η</span><span class="p">)</span>
                        <span class="n">U</span> <span class="o">=</span> <span class="n">u_prime</span><span class="p">(</span><span class="n">σ</span><span class="p">(</span><span class="n">R_hat</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">Y_hat</span><span class="p">,</span> <span class="n">z_hat</span><span class="p">))</span>
                        <span class="n">Ez</span> <span class="o">+=</span> <span class="n">R_hat</span> <span class="o">*</span> <span class="n">U</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">z_hat</span><span class="p">]</span>
            <span class="n">Ez</span> <span class="o">=</span> <span class="n">Ez</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">η_draws</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ζ_draws</span><span class="p">))</span>
            <span class="n">c_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span>  <span class="n">u_prime_inv</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Ez</span><span class="p">)</span>

    <span class="c1"># Calculate endogenous asset grid</span>
    <span class="n">ae_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">c_out</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">ae_out</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_grid</span> <span class="o">+</span> <span class="n">c_out</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]</span>

    <span class="c1"># Fixing a consumption-asset pair at (0, 0) improves interpolation</span>
    <span class="n">c_out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ae_out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">ae_out</span><span class="p">,</span> <span class="n">c_out</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="code-walkthrough">
<h3><span class="section-number">58.4.2. </span>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Link to this heading">#</a></h3>
<p>The operator creates a consumption function <code class="docutils literal notranslate"><span class="pre">σ</span></code> by interpolating the input policy, then uses triple nested loops to compute the expectation via Monte Carlo averaging over savings grid points, current states, future states, and shock realizations.</p>
<p>After computing optimal consumption <span class="math notranslate nohighlight">\(c_i\)</span> at each savings level <span class="math notranslate nohighlight">\(s_i\)</span> by inverting marginal utility, we construct the endogenous asset grid using <span class="math notranslate nohighlight">\(a_i = s_i + c_i\)</span>.</p>
<p>Setting consumption and assets to zero at the origin ensures smooth interpolation near zero assets, where the household consumes everything.</p>
<p>The next function solves for an approximation of the optimal consumption policy via time iteration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_model_time_iter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>        <span class="c1"># Class with model information</span>
                          <span class="n">a_vec</span><span class="p">,</span>        <span class="c1"># Initial condition for assets</span>
                          <span class="n">σ_vec</span><span class="p">,</span>        <span class="c1"># Initial condition for consumption</span>
                          <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                          <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">print_skip</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>

    <span class="c1"># Set up loop</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">tol</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iter</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">a_new</span><span class="p">,</span> <span class="n">σ_new</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">a_vec</span><span class="p">,</span> <span class="n">σ_vec</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">σ_vec</span> <span class="o">-</span> <span class="n">σ_new</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">print_skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error at iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">a_vec</span><span class="p">,</span> <span class="n">σ_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a_new</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">σ_new</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to converge!&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Converged in </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> iterations.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">σ_new</span>
</pre></div>
</div>
</div>
</div>
<p>This function implements fixed-point iteration by repeatedly applying the operator <span class="math notranslate nohighlight">\(K\)</span> until the policy converges.</p>
<p>Convergence is measured by the maximum absolute change in consumption across all states.</p>
<p>The operator is guaranteed to converge due to the contraction property discussed earlier.</p>
<p>Now we are ready to create an instance at the default parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ifp</span> <span class="o">=</span> <span class="n">IFP</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The default parameters represent a calibration with moderate risk aversion (<span class="math notranslate nohighlight">\(\gamma = 1.5\)</span>, CRRA utility) and a quarterly discount factor (<span class="math notranslate nohighlight">\(\beta = 0.96\)</span>, corresponding to roughly 4% annual discounting).</p>
<p>The Markov chain has high persistence (90% probability of staying in the current state), while returns have 10% volatility around a zero mean log return (<span class="math notranslate nohighlight">\(a_r = 0.1\)</span>, <span class="math notranslate nohighlight">\(b_r = 0.0\)</span>).</p>
<p>Labor income is state-dependent: <span class="math notranslate nohighlight">\(Y_t = \exp(0.2 \eta_t + 0.5 Z_t)\)</span> implies higher expected income in the good state (<span class="math notranslate nohighlight">\(Z_t = 1\)</span>) compared to the bad state (<span class="math notranslate nohighlight">\(Z_t = 0\)</span>).</p>
<p>Next we set up an initial condition, which corresponds to consuming all
assets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial guess of σ = consume all assets</span>
<span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">s_grid</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
<span class="n">σ_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">σ_init</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">s_grid</span>
<span class="n">a_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">σ_init</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s generate an approximation solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_star</span><span class="p">,</span> <span class="n">σ_star</span> <span class="o">=</span> <span class="n">solve_model_time_iter</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">a_init</span><span class="p">,</span> <span class="n">σ_init</span><span class="p">,</span> <span class="n">print_skip</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 5 is 0.5081944529506552.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 10 is 0.1057246950930697.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 15 is 0.03658262202883744.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 20 is 0.013936729965906114.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 25 is 0.00529216526971199.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 30 is 0.0019748126990770665.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 35 is 0.0007219210463285108.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 40 is 0.0002590544496094971.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 45 is 9.163966595471251e-05.

Converged in 45 iterations.
</pre></div>
</div>
</div>
</div>
<p>Here’s a plot of the resulting consumption policy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">P</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">σ_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;consumption when $z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e3ddbdfc56648e7e11d1c6aacef0b2a55c91b07d248de5d4ceba032ddc0c818c.png" src="_images/e3ddbdfc56648e7e11d1c6aacef0b2a55c91b07d248de5d4ceba032ddc0c818c.png" />
</div>
</div>
<p>Notice that we consume all assets in the lower range of the asset space.</p>
<p>This is because we anticipate income <span class="math notranslate nohighlight">\(Y_{t+1}\)</span> tomorrow, which makes the need to save less urgent.</p>
<p>Observe that consuming all assets ends earlier (at lower asset levels) when <span class="math notranslate nohighlight">\(z=0\)</span> compared to <span class="math notranslate nohighlight">\(z=1\)</span>.</p>
<p>This occurs because expected future income is lower in the bad state (<span class="math notranslate nohighlight">\(z=0\)</span>), so the household begins precautionary saving at lower wealth levels.</p>
<p>In contrast, when <span class="math notranslate nohighlight">\(z=1\)</span> (good state), higher expected future income allows the household to consume all assets up to a higher threshold before savings become optimal.</p>
</section>
<section id="law-of-motion">
<h3><span class="section-number">58.4.3. </span>Law of Motion<a class="headerlink" href="#law-of-motion" title="Link to this heading">#</a></h3>
<p>Let’s try to get some idea of what will happen to assets over the long run
under this consumption policy.</p>
<p>As with our <a class="reference internal" href="ifp.html"><span class="doc">earlier lecture</span></a> on the income fluctuation problem, we
begin by producing a 45 degree diagram showing the law of motion for assets</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good and bad state mean labor income</span>
<span class="n">Y_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">η_draws</span><span class="p">))</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="c1"># Mean returns</span>
<span class="n">R_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">R</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">ζ_draws</span><span class="p">))</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">a_star</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">lb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;bad state&#39;</span><span class="p">,</span> <span class="s1">&#39;good state&#39;</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">R_mean</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]</span> <span class="o">-</span> <span class="n">σ_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">])</span> <span class="o">+</span> <span class="n">Y_mean</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lb</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;current assets&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;next period assets&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6459ab71b2d50f7ebd23bd0b866b4f02d8a88c040d78fc053e8564dac759978e.png" src="_images/6459ab71b2d50f7ebd23bd0b866b4f02d8a88c040d78fc053e8564dac759978e.png" />
</div>
</div>
<p>The unbroken lines represent, for each <span class="math notranslate nohighlight">\(z\)</span>, an average update function
for assets, given by</p>
<div class="math notranslate nohighlight">
\[
a \mapsto \bar R (a - \sigma^*(a, z)) + \bar Y(z)
\]</div>
<p>Here</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\bar R = \mathbb E R_t\)</span>, which is mean returns and</p></li>
<li><p><span class="math notranslate nohighlight">\(\bar Y(z) = \mathbb E_z Y(z, \eta_t)\)</span>, which is mean labor income in state <span class="math notranslate nohighlight">\(z\)</span>.</p></li>
</ul>
<p>The dashed line is the 45 degree line.</p>
<p>We can see from the figure that the dynamics will be stable — assets do not
diverge even in the highest state.</p>
</section>
</section>
<section id="jax-implementation">
<h2><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">58.5. </span>JAX Implementation</a><a class="headerlink" href="#jax-implementation" title="Link to this heading">#</a></h2>
<p>We now provide a JAX implementation of the model.</p>
<p>JAX is a high-performance numerical computing library that provides automatic differentiation and JIT compilation, with support for GPU/TPU acceleration.</p>
<p>First we need to import JAX and related libraries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="c1"># Import jax.jit with a different name to avoid conflict with numba.jit</span>
<span class="n">jax_jit</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span>
</pre></div>
</div>
</div>
</div>
<p>We enable 64-bit precision in JAX to ensure accurate results that match the Numba implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the JAX version of the IFP class using NamedTuple for compatibility with JAX’s JIT compilation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IFP_JAX</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A NamedTuple that stores primitives for the income fluctuation</span>
<span class="sd">    problem, using JAX.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">γ</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">β</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">a_r</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">b_r</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">a_y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">b_y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">s_grid</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">η_draws</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">ζ_draws</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_ifp_jax</span><span class="p">(</span><span class="n">γ</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                   <span class="n">β</span><span class="o">=</span><span class="mf">0.96</span><span class="p">,</span>
                   <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)]),</span>
                   <span class="n">a_r</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                   <span class="n">b_r</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                   <span class="n">a_y</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                   <span class="n">b_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">shock_draw_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                   <span class="n">grid_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                   <span class="n">grid_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                   <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an instance of IFP_JAX with the given parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Test stability assuming {R_t} is IID and adopts the lognormal</span>
    <span class="c1"># specification given below.  The test is then β E R_t &lt; 1.</span>
    <span class="n">ER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b_r</span> <span class="o">+</span> <span class="n">a_r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">β</span> <span class="o">*</span> <span class="n">ER</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Stability condition failed.&quot;</span>

    <span class="c1"># Convert to JAX arrays</span>
    <span class="n">P_jax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="c1"># Generate random draws using JAX</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey1</span><span class="p">,</span> <span class="n">subkey2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">η_draws</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey1</span><span class="p">,</span> <span class="p">(</span><span class="n">shock_draw_size</span><span class="p">,))</span>
    <span class="n">ζ_draws</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey2</span><span class="p">,</span> <span class="p">(</span><span class="n">shock_draw_size</span><span class="p">,))</span>
    <span class="n">s_grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_max</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">IFP_JAX</span><span class="p">(</span><span class="n">γ</span><span class="o">=</span><span class="n">γ</span><span class="p">,</span> <span class="n">β</span><span class="o">=</span><span class="n">β</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P_jax</span><span class="p">,</span> <span class="n">a_r</span><span class="o">=</span><span class="n">a_r</span><span class="p">,</span> <span class="n">b_r</span><span class="o">=</span><span class="n">b_r</span><span class="p">,</span> <span class="n">a_y</span><span class="o">=</span><span class="n">a_y</span><span class="p">,</span> <span class="n">b_y</span><span class="o">=</span><span class="n">b_y</span><span class="p">,</span>
                   <span class="n">s_grid</span><span class="o">=</span><span class="n">s_grid</span><span class="p">,</span> <span class="n">η_draws</span><span class="o">=</span><span class="n">η_draws</span><span class="p">,</span> <span class="n">ζ_draws</span><span class="o">=</span><span class="n">ζ_draws</span><span class="p">)</span>


<span class="c1"># Utility functions for the IFP model</span>

<span class="k">def</span><span class="w"> </span><span class="nf">u_prime</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">γ</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Marginal utility&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">γ</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">u_prime_inv</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">γ</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inverse of marginal utility&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">γ</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">R</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ζ</span><span class="p">,</span> <span class="n">a_r</span><span class="p">,</span> <span class="n">b_r</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gross return on assets&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_r</span> <span class="o">*</span> <span class="n">ζ</span> <span class="o">+</span> <span class="n">b_r</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">η</span><span class="p">,</span> <span class="n">a_y</span><span class="p">,</span> <span class="n">b_y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Labor income&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_y</span> <span class="o">*</span> <span class="n">η</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">b_y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the Coleman-Reffett operator using JAX:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax_jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">K_jax</span><span class="p">(</span><span class="n">ae_vals</span><span class="p">,</span> <span class="n">c_vals</span><span class="p">,</span> <span class="n">ifp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Coleman--Reffett operator for the income fluctuation problem,</span>
<span class="sd">    using the endogenous grid method with JAX.</span>

<span class="sd">        * ifp is an instance of IFP_JAX</span>
<span class="sd">        * ae_vals[i, z] is an asset grid</span>
<span class="sd">        * c_vals[i, z] is consumption at ae_vals[i, z]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Extract parameters from ifp</span>
    <span class="n">γ</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">γ</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">P</span>
    <span class="n">a_r</span><span class="p">,</span> <span class="n">b_r</span><span class="p">,</span> <span class="n">a_y</span><span class="p">,</span> <span class="n">b_y</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">a_y</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">b_y</span>
    <span class="n">s_grid</span><span class="p">,</span> <span class="n">η_draws</span><span class="p">,</span> <span class="n">ζ_draws</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">s_grid</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">η_draws</span><span class="p">,</span> <span class="n">ifp</span><span class="o">.</span><span class="n">ζ_draws</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="c1"># Allocate memory</span>
    <span class="n">c_out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">c_vals</span><span class="p">)</span>

    <span class="c1"># Obtain c_i at each s_i, z, store in c_out[i, z], computing</span>
    <span class="c1"># the expectation term by Monte Carlo</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_expectation</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute expectation for given s and z&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">inner_expectation</span><span class="p">(</span><span class="n">z_hat</span><span class="p">):</span>
            <span class="c1"># Vectorize over shocks</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">compute_term</span><span class="p">(</span><span class="n">η</span><span class="p">,</span> <span class="n">ζ</span><span class="p">):</span>
                <span class="n">R_hat</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">z_hat</span><span class="p">,</span> <span class="n">ζ</span><span class="p">,</span> <span class="n">a_r</span><span class="p">,</span> <span class="n">b_r</span><span class="p">)</span>
                <span class="n">Y_hat</span> <span class="o">=</span> <span class="n">Y</span><span class="p">(</span><span class="n">z_hat</span><span class="p">,</span> <span class="n">η</span><span class="p">,</span> <span class="n">a_y</span><span class="p">,</span> <span class="n">b_y</span><span class="p">)</span>
                <span class="n">a_val</span> <span class="o">=</span> <span class="n">R_hat</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">Y_hat</span>
                <span class="c1"># Interpolate consumption</span>
                <span class="n">c_interp</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">a_val</span><span class="p">,</span> <span class="n">ae_vals</span><span class="p">[:,</span> <span class="n">z_hat</span><span class="p">],</span> <span class="n">c_vals</span><span class="p">[:,</span> <span class="n">z_hat</span><span class="p">])</span>
                <span class="n">U</span> <span class="o">=</span> <span class="n">u_prime</span><span class="p">(</span><span class="n">c_interp</span><span class="p">,</span> <span class="n">γ</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">R_hat</span> <span class="o">*</span> <span class="n">U</span>

            <span class="c1"># Vectorize over all shock combinations</span>
            <span class="n">η_grid</span><span class="p">,</span> <span class="n">ζ_grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">η_draws</span><span class="p">,</span> <span class="n">ζ_draws</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">compute_term</span><span class="p">))(</span><span class="n">η_grid</span><span class="p">,</span> <span class="n">ζ_grid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">P</span><span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">z_hat</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>

        <span class="c1"># Sum over z_hat states</span>
        <span class="n">Ez</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">inner_expectation</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">u_prime_inv</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Ez</span><span class="p">,</span> <span class="n">γ</span><span class="p">)</span>

    <span class="c1"># Vectorize over s_grid and z</span>
    <span class="n">c_out</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">compute_expectation</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                  <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="n">s_grid</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># Calculate endogenous asset grid</span>
    <span class="n">ae_out</span> <span class="o">=</span> <span class="n">s_grid</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_out</span>

    <span class="c1"># Fixing a consumption-asset pair at (0, 0) improves interpolation</span>
    <span class="n">c_out</span> <span class="o">=</span> <span class="n">c_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ae_out</span> <span class="o">=</span> <span class="n">ae_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ae_out</span><span class="p">,</span> <span class="n">c_out</span>
</pre></div>
</div>
</div>
</div>
<p>The next function solves for an approximation of the optimal consumption policy via time iteration using JAX:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_model_time_iter_jax</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>        <span class="c1"># Class with model information</span>
                               <span class="n">a_vec</span><span class="p">,</span>        <span class="c1"># Initial condition for assets</span>
                               <span class="n">σ_vec</span><span class="p">,</span>        <span class="c1"># Initial condition for consumption</span>
                               <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                               <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">print_skip</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>

    <span class="c1"># Set up loop</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">tol</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iter</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">a_new</span><span class="p">,</span> <span class="n">σ_new</span> <span class="o">=</span> <span class="n">K_jax</span><span class="p">(</span><span class="n">a_vec</span><span class="p">,</span> <span class="n">σ_vec</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">σ_vec</span> <span class="o">-</span> <span class="n">σ_new</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">print_skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error at iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">a_vec</span><span class="p">,</span> <span class="n">σ_vec</span> <span class="o">=</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">σ_new</span>

    <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to converge!&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Converged in </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> iterations.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">σ_new</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can create an instance and solve the model using JAX:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ifp_jax</span> <span class="o">=</span> <span class="n">create_ifp_jax</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Set up the initial condition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial guess of σ = consume all assets</span>
<span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifp_jax</span><span class="o">.</span><span class="n">s_grid</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifp_jax</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
<span class="n">σ_init_jax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">σ_init_jax</span> <span class="o">=</span> <span class="n">σ_init_jax</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ifp_jax</span><span class="o">.</span><span class="n">s_grid</span><span class="p">)</span>
<span class="n">a_init_jax</span> <span class="o">=</span> <span class="n">σ_init_jax</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s generate an approximation solution with JAX:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_star_jax</span><span class="p">,</span> <span class="n">σ_star_jax</span> <span class="o">=</span> <span class="n">solve_model_time_iter_jax</span><span class="p">(</span><span class="n">ifp_jax</span><span class="p">,</span> <span class="n">a_init_jax</span><span class="p">,</span> <span class="n">σ_init_jax</span><span class="p">,</span> <span class="n">print_skip</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error at iteration 5 is 0.5056668931888328.
Error at iteration 10 is 0.1034861379984835.
Error at iteration 15 is 0.03412817463153939.
Error at iteration 20 is 0.01201705155740429.
Error at iteration 25 is 0.004145424467285608.
Error at iteration 30 is 0.001391633566658168.
Error at iteration 35 is 0.0004556358742306976.
Error at iteration 40 is 0.00014622723914969882.

Converged in 42 iterations.
</pre></div>
</div>
</div>
</div>
<p>Here’s a plot comparing the JAX solution with the Numba solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ifp_jax</span><span class="o">.</span><span class="n">P</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_star_jax</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">σ_star_jax</span><span class="p">[:,</span> <span class="n">z</span><span class="p">]),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;JAX: consumption when $z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">σ_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Numba: consumption when $z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7602b429e80f30b8598b5373dde932c1aefb1e2353334fc29d9663b545bb4eb8.png" src="_images/7602b429e80f30b8598b5373dde932c1aefb1e2353334fc29d9663b545bb4eb8.png" />
</div>
</div>
<section id="comparison-of-numba-and-jax-solutions">
<h3><span class="section-number">58.5.1. </span>Comparison of Numba and JAX Solutions<a class="headerlink" href="#comparison-of-numba-and-jax-solutions" title="Link to this heading">#</a></h3>
<p>Now let’s verify that both implementations produce nearly identical results.</p>
<p>With 64-bit precision enabled in JAX, we expect the solutions to be very close.</p>
<p>Let’s compute the maximum absolute differences:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert JAX arrays to NumPy for comparison</span>
<span class="n">a_star_jax_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_star_jax</span><span class="p">)</span>
<span class="n">σ_star_jax_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">σ_star_jax</span><span class="p">)</span>

<span class="c1"># Compute differences</span>
<span class="n">a_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a_star</span> <span class="o">-</span> <span class="n">a_star_jax_np</span><span class="p">)</span>
<span class="n">σ_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">σ_star</span> <span class="o">-</span> <span class="n">σ_star_jax_np</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparison of Numba and JAX solutions:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max absolute difference in asset grid: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a_diff</span><span class="p">)</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean absolute difference in asset grid: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a_diff</span><span class="p">)</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max absolute difference in consumption: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">σ_diff</span><span class="p">)</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean absolute difference in consumption: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">σ_diff</span><span class="p">)</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Comparison of Numba and JAX solutions:
==================================================
Max absolute difference in asset grid: 5.377e-02
Mean absolute difference in asset grid: 3.559e-02
Max absolute difference in consumption: 5.377e-02
Mean absolute difference in consumption: 3.559e-02
</pre></div>
</div>
</div>
</div>
<p>Let’s also visualize the differences:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">P</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">a_diff</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">σ_diff</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;absolute difference&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Asset Grid Differences: |Numba - JAX|&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;absolute difference&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Consumption Differences: |Numba - JAX|&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ec2966a6dbac28a323846d2f132683c927c19ea9b9fc8a222cc5e12540a54431.png" src="_images/ec2966a6dbac28a323846d2f132683c927c19ea9b9fc8a222cc5e12540a54431.png" />
</div>
</div>
<p>As we can see, the differences between the two implementations are extremely small (on the order of machine precision), confirming that both methods produce essentially identical results.</p>
<p>The tiny differences arise from:</p>
<ul class="simple">
<li><p>Different random number generators (NumPy vs JAX)</p></li>
<li><p>Minor differences in floating-point operations order</p></li>
<li><p>Different interpolation implementations</p></li>
</ul>
<p>Despite these minor numerical differences, both implementations converge to the same optimal policy.</p>
<p>The JAX implementation provides several advantages:</p>
<ol class="arabic simple">
<li><p><strong>GPU/TPU acceleration</strong>: JAX can automatically utilize GPU/TPU hardware for faster computation</p></li>
<li><p><strong>Automatic differentiation</strong>: JAX provides automatic differentiation, which can be useful for sensitivity analysis</p></li>
<li><p><strong>Functional programming</strong>: JAX encourages a functional style that can be easier to reason about and parallelize</p></li>
</ol>
</section>
</section>
<section id="exercises">
<h2><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">58.6. </span>Exercises</a><a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<div class="exercise admonition" id="ifpa_ex1">

<p class="admonition-title"><span class="caption-number">Exercise 58.1 </span></p>
<section id="exercise-content">
<p>Let’s repeat our <a class="reference internal" href="ifp.html#ifp_ex2"><span class="std std-ref">earlier exercise</span></a> on the long-run
cross sectional distribution of assets.</p>
<p>In that exercise, we used a relatively simple income fluctuation model.</p>
<p>In the solution, we found the shape of the asset distribution to be unrealistic.</p>
<p>In particular, we failed to match the long right tail of the wealth distribution.</p>
<p>Your task is to try again, repeating the exercise, but now with our more sophisticated model.</p>
<p>Use the default parameters.</p>
</section>
</div>
<div class="solution dropdown admonition" id="ifp_advanced-solution-1">

<p class="admonition-title">Solution</p>
<section id="solution-content">
<p>First we write a function to compute a long asset series.</p>
<p>Because we want to JIT-compile the function, we code the solution in a way
that breaks some rules on good programming style.</p>
<p>For example, we will pass in the solutions <code class="docutils literal notranslate"><span class="pre">a_star,</span> <span class="pre">σ_star</span></code> along with
<code class="docutils literal notranslate"><span class="pre">ifp</span></code>, even though it would be more natural to just pass in <code class="docutils literal notranslate"><span class="pre">ifp</span></code> and then
solve inside the function.</p>
<p>The reason we do this is that <code class="docutils literal notranslate"><span class="pre">solve_model_time_iter</span></code> is not
JIT-compiled.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_asset_series</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">a_star</span><span class="p">,</span> <span class="n">σ_star</span><span class="p">,</span> <span class="n">z_seq</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">500_000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates a time series of length T for assets, given optimal</span>
<span class="sd">    savings behavior.</span>

<span class="sd">        * ifp is an instance of IFP</span>
<span class="sd">        * a_star is the endogenous grid solution</span>
<span class="sd">        * σ_star is optimal consumption on the grid</span>
<span class="sd">        * z_seq is a time path for {Z_t}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create consumption function by linear interpolation</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">],</span> <span class="n">σ_star</span><span class="p">[:,</span> <span class="n">z</span><span class="p">])</span>

    <span class="c1"># Simulate the asset path</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z_seq</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">ζ</span><span class="p">,</span> <span class="n">η</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">R</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ζ</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">η</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">σ</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">z</span><span class="p">))</span> <span class="o">+</span> <span class="n">Y</span>
    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<p>Now we call the function, generate the series and then histogram it, using the
solutions computed above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">mc</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="n">ifp</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
<span class="n">z_seq</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">compute_asset_series</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">a_star</span><span class="p">,</span> <span class="n">σ_star</span><span class="p">,</span> <span class="n">z_seq</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5824291d250ae8ff036caf284212de2f3aaf5942d7e4efc3e7d3eb25ddcc9162.png" src="_images/5824291d250ae8ff036caf284212de2f3aaf5942d7e4efc3e7d3eb25ddcc9162.png" />
</div>
</div>
<p>Now we have managed to successfully replicate the long right tail of the
wealth distribution.</p>
<p>Here’s another view of this using a horizontal violin plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showmedians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/77985512000d2b2dcbb17a567d9ddf8e5c52cc6af61df40aecda69eb4642b083.png" src="_images/77985512000d2b2dcbb17a567d9ddf8e5c52cc6af61df40aecda69eb4642b083.png" />
</div>
</div>
</section>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                    <p>A theme by <a href="https://quantecon.org">QuantEcon</a></p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="sir_model.html">
   1. Modeling COVID 19
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linear_algebra.html">
   2. Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="qr_decomp.html">
   3. QR Decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="eig_circulant.html">
   4. Circulant Matrices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="svd_intro.html">
   5. Singular Value Decomposition (SVD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="var_dmd.html">
   6. VARs and DMDs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="newton_method.html">
   7. Using Newton’s Method to Solve Economic Models
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Elementary Statistics
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="prob_matrix.html">
   8. Elementary Probability with Matrices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stats_examples.html">
   9. Some Probability Distributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lln_clt.html">
   10. LLN and CLT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="prob_meaning.html">
   11. Two Meanings of Probability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multi_hyper.html">
   12. Multivariate Hypergeometric Distribution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multivariate_normal.html">
   13. Multivariate Normal Distribution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hoist_failure.html">
   14. Fault Tree Uncertainties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="back_prop.html">
   15. Introduction to Artificial Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rand_resp.html">
   16. Randomized Response Surveys
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="util_rand_resp.html">
   17. Expected Utilities of Random Responses
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Bayes Law
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="bayes_nonconj.html">
   18. Non-Conjugate Priors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ar1_bayes.html">
   19. Posterior Distributions for  AR(1) Parameters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ar1_turningpts.html">
   20. Forecasting  an AR(1) Process
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Statistics and Information
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="divergence_measures.html">
   21. Statistical Divergence Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="likelihood_ratio_process.html">
   22. Likelihood Ratio Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="likelihood_ratio_process_2.html">
   23. Heterogeneous Beliefs and Financial Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="likelihood_var.html">
   24. Likelihood Processes For VAR Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="imp_sample.html">
   25. Mean of a Likelihood Ratio Process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wald_friedman.html">
   26. A Problem that Stumped Milton Friedman
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wald_friedman_2.html">
   27. A Bayesian Formulation of Friedman and Wald’s Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="exchangeable.html">
   28. Exchangeability and Bayesian Updating
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="likelihood_bayes.html">
   29. Likelihood Ratio Processes and Bayesian Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mix_model.html">
   30. Incorrect Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="navy_captain.html">
   31. Bayesian versus Frequentist Decision Rules
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Linear Programming
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="opt_transport.html">
   32. Optimal Transport
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="von_neumann_model.html">
   33. Von Neumann Growth Model (and a Generalization)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Dynamics
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="finite_markov.html">
   34. Finite Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="inventory_dynamics.html">
   35. Inventory Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linear_models.html">
   36. Linear State Space Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="samuelson.html">
   37. Samuelson Multiplier-Accelerator
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kesten_processes.html">
   38. Kesten Processes and Firm Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wealth_dynamics.html">
   39. Wealth Distribution Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kalman.html">
   40. A First Look at the Kalman Filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kalman_2.html">
   41. Another Look at the Kalman Filter
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Search
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_model.html">
   42. Job Search I: The McCall Search Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_model_with_separation.html">
   43. Job Search II: Search and Separation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_model_with_sep_markov.html">
   44. Job Search III: Search with Separation and Markov Wages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_fitted_vfi.html">
   45. Job Search IV: Fitted Value Function Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_persist_trans.html">
   46. Job Search V: Persistent and Transitory Wage Shocks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="career.html">
   47. Job Search VI: Modeling Career Choice
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="jv.html">
   48. Job Search VII: On-the-Job Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="odu.html">
   49. Job Search VIII: Search with Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_q.html">
   50. Job Search IX: Search with Q-Learning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Household Problems
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating.html">
   51. Cake Eating I: Introduction to Optimal Saving
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_numerical.html">
   52. Cake Eating II: Numerical Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_stochastic.html">
   53. Cake Eating III: Stochastic Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_time_iter.html">
   54. Cake Eating IV: Time Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_egm.html">
   55. Cake Eating V: The Endogenous Grid Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_egm_jax.html">
   56. Cake Eating VI: EGM with JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ifp.html">
   57. The Income Fluctuation Problem I: Basic Model
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   58. The Income Fluctuation Problem II: Stochastic Returns on Assets
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  LQ Control
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lqcontrol.html">
   59. LQ Control: Foundations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lagrangian_lqdp.html">
   60. Lagrangian for LQ Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cross_product_trick.html">
   61. Eliminating Cross Products
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="perm_income.html">
   62. The Permanent Income Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="perm_income_cons.html">
   63. Permanent Income II: LQ Techniques
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lq_inventories.html">
   64. Production Smoothing via Inventories
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Optimal Growth
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cass_koopmans_1.html">
   65. Cass-Koopmans Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cass_koopmans_2.html">
   66. Cass-Koopmans Competitive Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cass_fiscal.html">
   67. Cass-Koopmans Model with Distorting Taxes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cass_fiscal_2.html">
   68. Two-Country Model with Distorting Taxes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ak2.html">
   69. Transitions in an Overlapping Generations Model
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lake_model.html">
   70. A Lake Model of Employment and Unemployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="endogenous_lake.html">
   71. Lake Model with an Endogenous Job Finding Rate
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rational_expectations.html">
   72. Rational Expectations Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="re_with_feedback.html">
   73. Stability in Linear Rational Expectations Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="markov_perf.html">
   74. Markov Perfect Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="uncertainty_traps.html">
   75. Uncertainty Traps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="aiyagari.html">
   76. The Aiyagari Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ak_aiyagari.html">
   77. A Long-Lived, Heterogeneous Agent, Overlapping Generations Model
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Asset Pricing and Finance
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="markov_asset.html">
   78. Asset Pricing: Finite State Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ge_arrow.html">
   79. Competitive Equilibria with Arrow Securities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="harrison_kreps.html">
   80. Heterogeneous Beliefs and Bubbles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="morris_learn.html">
   81. Speculative Behavior with Bayesian Learning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data and Empirics
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="pandas_panel.html">
   82. Pandas for Panel Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ols.html">
   83. Linear Regression in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mle.html">
   84. Maximum Likelihood Estimation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Auctions
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="two_auctions.html">
   85. First-Price and Second-Price Auctions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="house_auction.html">
   86. Multiple Good Allocation Mechanisms
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   87. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   88. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="status.html">
   89. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                </ul>

                <ul class="qe-toolbar__links">
                    <li class="btn__search">
                        <form action="search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off" accesskey="k">
                            <i data-feather="search" id="search-icon"></i>
                        </form>
                    </li>
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/ifp_advanced.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <!--
                    # Enable if looking for link to specific document hosted on GitHub
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python.myst/blob/main/lectures/ifp_advanced.md" download><i data-feather="github"></i></a></li>
                    -->
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python.myst" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="/_pdf/quantecon-python.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-python.notebooks/blob/main/ifp_advanced.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-python.notebooks" data-urlpath="tree/lecture-python.notebooks/ifp_advanced.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://colab.research.google.com/github/QuantEcon/lecture-python.notebooks/blob/main/ifp_advanced.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "ifp_advanced";
                const repoURL = "https://github.com/QuantEcon/lecture-python.notebooks";
                const urlPath = "tree/lecture-python.notebooks/ifp_advanced.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>