
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>12. Multivariate Normal Distribution &#8212; Quantitative Economics with Python</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/quantecon-book-theme.1ef59f8f4e91ec8319176e8479c6af4e.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">


    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="_static/quantecon-book-theme.15b0c36fffe88f468997fa7b698991d3.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://python.quantecon.org/multivariate_normal.html" />
    <link rel="shortcut icon" href="_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="13. Fault Tree Uncertainties" href="hoist_failure.html" />
    <link rel="prev" title="11. Heavy-Tailed Distributions" href="heavy_tails.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Python, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Multivariate Normal Distribution"/>
<meta name="twitter:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Multivariate Normal Distribution" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://python.quantecon.org/multivariate_normal.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski." />
<meta property="og:site_name" content="Quantitative Economics with Python" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>


    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=multivariate_normal>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   12.1. Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-multivariate-normal-distribution">
   12.2. The Multivariate Normal Distribution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bivariate-example">
   12.3. Bivariate Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trivariate-example">
   12.4. Trivariate Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#one-dimensional-intelligence-iq">
   12.5. One Dimensional Intelligence (IQ)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#another-representation">
   12.6. Another representation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#magic-of-the-cholesky-factorization">
   12.7. Magic of the Cholesky factorization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#math-and-verbal-components-of-intelligence">
   12.8. Math and Verbal Components of Intelligence
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#univariate-time-series-analysis">
   12.9. Univariate Time Series Analysis
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#smoothing-example">
     12.9.1. Smoothing Example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filtering-exercise">
     12.9.2. Filtering Exercise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prediction-exercise">
     12.9.3. Prediction Exercise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#constructing-a-wold-representation">
     12.9.4. Constructing a Wold Representation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#classic-factor-analysis-model">
   12.10. Classic Factor Analysis Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pca-as-approximation-to-factor-analytic-model">
   12.11. PCA as Approximation to Factor Analytic Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stochastic-difference-equation">
   12.12. Stochastic Difference Equation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#application-to-stock-price-model">
   12.13. Application to Stock Price Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#filtering-foundations">
   12.14. Filtering Foundations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-toward-dynamics">
     12.14.1. Step toward dynamics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dynamic-version">
     12.14.2. Dynamic version
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-for-iterating">
     12.14.3. Code for Iterating
    </a>
   </li>
  </ul>
 </li>
</ul>

                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="_static/qe-logo-large.png" class="logo" alt="logo"></a>
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="intro.html">Quantitative Economics with Python</a></p>

                        <p class="qe-page__header-subheading">Multivariate Normal Distribution</p>

                    </div>

                    <p class="qe-page__header-authors">Thomas J. Sargent & John Stachurski</p>

                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" align="right" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" width="250px" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><section class="tex2jax_ignore mathjax_ignore" id="multivariate-normal-distribution">
<h1><a class="toc-backref" href="#id1"><span class="section-number">12. </span>Multivariate Normal Distribution</a><a class="headerlink" href="#multivariate-normal-distribution" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#multivariate-normal-distribution" id="id1">Multivariate Normal Distribution</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#the-multivariate-normal-distribution" id="id3">The Multivariate Normal Distribution</a></p></li>
<li><p><a class="reference internal" href="#bivariate-example" id="id4">Bivariate Example</a></p></li>
<li><p><a class="reference internal" href="#trivariate-example" id="id5">Trivariate Example</a></p></li>
<li><p><a class="reference internal" href="#one-dimensional-intelligence-iq" id="id6">One Dimensional Intelligence (IQ)</a></p></li>
<li><p><a class="reference internal" href="#another-representation" id="id7">Another representation</a></p></li>
<li><p><a class="reference internal" href="#magic-of-the-cholesky-factorization" id="id8">Magic of the Cholesky factorization</a></p></li>
<li><p><a class="reference internal" href="#math-and-verbal-components-of-intelligence" id="id9">Math and Verbal Components of Intelligence</a></p></li>
<li><p><a class="reference internal" href="#univariate-time-series-analysis" id="id10">Univariate Time Series Analysis</a></p></li>
<li><p><a class="reference internal" href="#classic-factor-analysis-model" id="id11">Classic Factor Analysis Model</a></p></li>
<li><p><a class="reference internal" href="#pca-as-approximation-to-factor-analytic-model" id="id12">PCA as Approximation to Factor Analytic Model</a></p></li>
<li><p><a class="reference internal" href="#stochastic-difference-equation" id="id13">Stochastic Difference Equation</a></p></li>
<li><p><a class="reference internal" href="#application-to-stock-price-model" id="id14">Application to Stock Price Model</a></p></li>
<li><p><a class="reference internal" href="#filtering-foundations" id="id15">Filtering Foundations</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id2"><span class="section-number">12.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This lecture describes a workhorse in probability theory, statistics, and economics, namely,
the <strong>multivariate normal distribution</strong>.</p>
<p>In this lecture, you will learn formulas for</p>
<ul class="simple">
<li><p>the joint distribution of a random vector <span class="math notranslate nohighlight">\(x\)</span> of length <span class="math notranslate nohighlight">\(N\)</span></p></li>
<li><p>marginal distributions for all subvectors of <span class="math notranslate nohighlight">\(x\)</span></p></li>
<li><p>conditional distributions for subvectors of <span class="math notranslate nohighlight">\(x\)</span> conditional on other subvectors of <span class="math notranslate nohighlight">\(x\)</span></p></li>
</ul>
<p>We will use  the multivariate normal distribution to formulate some classic models:</p>
<ul class="simple">
<li><p>a <strong>factor analytic model</strong> of an intelligence quotient, i.e., IQ</p></li>
<li><p>a <strong>factor analytic model</strong> of two independent inherent abilities, mathematical and verbal.</p></li>
<li><p>a more general factor analytic model</p></li>
<li><p>PCA as an approximation to a factor analytic model</p></li>
<li><p>time series generated by linear stochastic difference equations</p></li>
<li><p>optimal linear filtering theory</p></li>
</ul>
</section>
<section id="the-multivariate-normal-distribution">
<h2><a class="toc-backref" href="#id3"><span class="section-number">12.2. </span>The Multivariate Normal Distribution</a><a class="headerlink" href="#the-multivariate-normal-distribution" title="Permalink to this headline">¶</a></h2>
<p>This lecture defines a Python class <code class="docutils literal notranslate"><span class="pre">MultivariateNormal</span></code> to be used
to generate <strong>marginal</strong> and <strong>conditional</strong> distributions associated
with a multivariate normal distribution.</p>
<p>For a multivariate normal distribution it is very convenient that</p>
<ul class="simple">
<li><p>conditional expectations equal linear least squares projections</p></li>
<li><p>conditional distributions are characterized by multivariate linear
regressions</p></li>
</ul>
<p>We apply our Python class to some classic examples.</p>
<p>We will use the following imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1">#set default figure size</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
</div>
</div>
<p>Assume that an <span class="math notranslate nohighlight">\(N \times 1\)</span> random vector <span class="math notranslate nohighlight">\(z\)</span> has a
multivariate normal probability density.</p>
<p>This means that the probability density takes the form</p>
<div class="math notranslate nohighlight">
\[
f\left(z;\mu,\Sigma\right)=\left(2\pi\right)^{-\left(\frac{N}{2}\right)}\det\left(\Sigma\right)^{-\frac{1}{2}}\exp\left(-.5\left(z-\mu\right)^{\prime}\Sigma^{-1}\left(z-\mu\right)\right)
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu=Ez\)</span> is the mean of the random vector <span class="math notranslate nohighlight">\(z\)</span> and
<span class="math notranslate nohighlight">\(\Sigma=E\left(z-\mu\right)\left(z-\mu\right)^\prime\)</span> is the
covariance matrix of <span class="math notranslate nohighlight">\(z\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The density function of multivariate normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------------</span>
<span class="sd">    z: ndarray(float, dim=2)</span>
<span class="sd">        random vector, N by 1</span>
<span class="sd">    μ: ndarray(float, dim=1 or 2)</span>
<span class="sd">        the mean of z, N by 1</span>
<span class="sd">    Σ: ndarray(float, dim=2)</span>
<span class="sd">        the covarianece matrix of z, N by 1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
    <span class="n">Σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Σ</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">size</span>

    <span class="n">temp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Σ</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">temp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">μ</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Σ</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">μ</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp1</span> <span class="o">*</span> <span class="n">temp2</span>
</pre></div>
</div>
</div>
</div>
<p>For some integer <span class="math notranslate nohighlight">\(k\in \{2,\dots, N-1\}\)</span>, partition
<span class="math notranslate nohighlight">\(z\)</span> as
<span class="math notranslate nohighlight">\(z=\left[\begin{array}{c} z_{1}\\ z_{2} \end{array}\right]\)</span>, where
<span class="math notranslate nohighlight">\(z_1\)</span> is an <span class="math notranslate nohighlight">\(\left(N-k\right)\times1\)</span> vector and <span class="math notranslate nohighlight">\(z_2\)</span>
is a <span class="math notranslate nohighlight">\(k\times1\)</span> vector.</p>
<p>Let</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mu=\left[\begin{array}{c}
\mu_{1}\\
\mu_{2}
\end{array}\right],\quad\Sigma=\left[\begin{array}{cc}
\Sigma_{11} &amp; \Sigma_{12}\\
\Sigma_{21} &amp; \Sigma_{22}
\end{array}\right]
\end{split}\]</div>
<p>be corresponding partitions of <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\Sigma\)</span>.</p>
<p>The <strong>marginal</strong> distribution of <span class="math notranslate nohighlight">\(z_1\)</span> is</p>
<ul class="simple">
<li><p>multivariate normal with mean <span class="math notranslate nohighlight">\(\mu_1\)</span> and covariance matrix
<span class="math notranslate nohighlight">\(\Sigma_{11}\)</span>.</p></li>
</ul>
<p>The <strong>marginal</strong> distribution of <span class="math notranslate nohighlight">\(z_2\)</span> is</p>
<ul class="simple">
<li><p>multivariate normal with mean <span class="math notranslate nohighlight">\(\mu_2\)</span> and covariance matrix
<span class="math notranslate nohighlight">\(\Sigma_{22}\)</span>.</p></li>
</ul>
<p>The distribution of <span class="math notranslate nohighlight">\(z_1\)</span> <strong>conditional</strong> on <span class="math notranslate nohighlight">\(z_2\)</span> is</p>
<ul class="simple">
<li><p>multivariate normal with mean</p></li>
</ul>
<div class="math notranslate nohighlight">
\[
\hat{\mu}_1 = \mu_1 + \beta \left(z_2 -\mu_2\right)
\]</div>
<p>and covariance matrix</p>
<div class="math notranslate nohighlight">
\[
\hat{\Sigma}_{11}=\Sigma_{11}-\Sigma_{12}\Sigma_{22}^{-1}\Sigma_{21}=\Sigma_{11}-\beta\Sigma_{22}\beta^{\prime}
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
\beta = \Sigma_{12}\Sigma_{22}^{-1}
\]</div>
<p>is an <span class="math notranslate nohighlight">\(\left(N-k\right) \times k\)</span> matrix of <strong>population
regression coefficients</strong> of <span class="math notranslate nohighlight">\(z_1 - \mu_1\)</span> on <span class="math notranslate nohighlight">\(z_2 - \mu_2\)</span>.</p>
<p>The following class constructs a multivariate normal distribution
instance with two methods.</p>
<ul class="simple">
<li><p>a method <code class="docutils literal notranslate"><span class="pre">partition</span></code> computes <span class="math notranslate nohighlight">\(\beta\)</span>, taking <span class="math notranslate nohighlight">\(k\)</span> as an
input</p></li>
<li><p>a method <code class="docutils literal notranslate"><span class="pre">cond_dist</span></code> computes either the distribution of
<span class="math notranslate nohighlight">\(z_1\)</span> conditional on <span class="math notranslate nohighlight">\(z_2\)</span> or the distribution of
<span class="math notranslate nohighlight">\(z_2\)</span> conditional on <span class="math notranslate nohighlight">\(z_1\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MultivariateNormal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class of multivariate normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    μ: ndarray(float, dim=1)</span>
<span class="sd">        the mean of z, N by 1</span>
<span class="sd">    Σ: ndarray(float, dim=2)</span>
<span class="sd">        the covarianece matrix of z, N by 1</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    μ, Σ:</span>
<span class="sd">        see parameters</span>
<span class="sd">    μs: list(ndarray(float, dim=1))</span>
<span class="sd">        list of mean vectors μ1 and μ2 in order</span>
<span class="sd">    Σs: list(list(ndarray(float, dim=2)))</span>
<span class="sd">        2 dimensional list of covariance matrices</span>
<span class="sd">        Σ11, Σ12, Σ21, Σ22 in order</span>
<span class="sd">    βs: list(ndarray(float, dim=1))</span>
<span class="sd">        list of regression coefficients β1 and β2 in order</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">):</span>
        <span class="s2">&quot;initialization&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Σ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given k, partition the random vector z into a size k vector z1</span>
<span class="sd">        and a size N-k vector z2. Partition the mean vector μ into</span>
<span class="sd">        μ1 and μ2, and the covariance matrix Σ into Σ11, Σ12, Σ21, Σ22</span>
<span class="sd">        correspondingly. Compute the regression coefficients β1 and β2</span>
<span class="sd">        using the partitioned arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">μ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">μ</span>
        <span class="n">Σ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Σ</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">μs</span> <span class="o">=</span> <span class="p">[</span><span class="n">μ</span><span class="p">[:</span><span class="n">k</span><span class="p">],</span> <span class="n">μ</span><span class="p">[</span><span class="n">k</span><span class="p">:]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Σs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Σ</span><span class="p">[:</span><span class="n">k</span><span class="p">,</span> <span class="p">:</span><span class="n">k</span><span class="p">],</span> <span class="n">Σ</span><span class="p">[:</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">:]],</span>
                   <span class="p">[</span><span class="n">Σ</span><span class="p">[</span><span class="n">k</span><span class="p">:,</span> <span class="p">:</span><span class="n">k</span><span class="p">],</span> <span class="n">Σ</span><span class="p">[</span><span class="n">k</span><span class="p">:,</span> <span class="n">k</span><span class="p">:]]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">βs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Σs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Σs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">Σs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Σs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>

    <span class="k">def</span> <span class="nf">cond_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the conditional distribution of z1 given z2, or reversely.</span>
<span class="sd">        Argument ind determines whether we compute the conditional</span>
<span class="sd">        distribution of z1 (ind=0) or z2 (ind=1).</span>

<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        μ_hat: ndarray(float, ndim=1)</span>
<span class="sd">            The conditional mean of z1 or z2.</span>
<span class="sd">        Σ_hat: ndarray(float, ndim=2)</span>
<span class="sd">            The conditional covariance matrix of z1 or z2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">βs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">μs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">μs</span>
        <span class="n">Σs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Σs</span>

        <span class="n">μ_hat</span> <span class="o">=</span> <span class="n">μs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">β</span> <span class="o">@</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">μs</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">Σ_hat</span> <span class="o">=</span> <span class="n">Σs</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">β</span> <span class="o">@</span> <span class="n">Σs</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">ind</span><span class="p">][</span><span class="mi">1</span><span class="o">-</span><span class="n">ind</span><span class="p">]</span> <span class="o">@</span> <span class="n">β</span><span class="o">.</span><span class="n">T</span>

        <span class="k">return</span> <span class="n">μ_hat</span><span class="p">,</span> <span class="n">Σ_hat</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s put this code to work on a suite of examples.</p>
<p>We begin with a simple bivariate example; after that we’ll turn to a
trivariate example.</p>
<p>We’ll compute population moments of some conditional distributions using
our <code class="docutils literal notranslate"><span class="pre">MultivariateNormal</span></code> class.</p>
<p>Then for fun we’ll compute sample analogs of the associated population
regressions by generating simulations and then computing linear least
squares regressions.</p>
<p>We’ll compare those linear least squares regressions for the simulated
data to their population counterparts.</p>
</section>
<section id="bivariate-example">
<h2><a class="toc-backref" href="#id4"><span class="section-number">12.3. </span>Bivariate Example</a><a class="headerlink" href="#bivariate-example" title="Permalink to this headline">¶</a></h2>
<p>We start with a bivariate normal distribution pinned down by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mu=\left[\begin{array}{c}
0\\
0
\end{array}\right],\quad\Sigma=\left[\begin{array}{cc}
1 &amp; .2\\
.2 &amp; 1
\end{array}\right]
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
<span class="n">Σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">.2</span> <span class="p">,</span><span class="mf">1.</span><span class="p">]])</span>

<span class="c1"># construction of the multivariate normal instance</span>
<span class="n">multi_normal</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># choose partition</span>

<span class="c1"># partition and compute regression coefficients</span>
<span class="n">multi_normal</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">multi_normal</span><span class="o">.</span><span class="n">βs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.2]])
</pre></div>
</div>
</div>
</div>
<p>Let’s compute the mean and variance of the distribution of <span class="math notranslate nohighlight">\(z_1\)</span>
conditional on <span class="math notranslate nohighlight">\(z_2=5\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cond. dist. of z1</span>
<span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">])</span> <span class="c1"># given z2</span>

<span class="n">μ1_hat</span><span class="p">,</span> <span class="n">Σ1_hat</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;μ1_hat, Σ1_hat = &#39;</span><span class="p">,</span> <span class="n">μ1_hat</span><span class="p">,</span> <span class="n">Σ1_hat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>μ1_hat, Σ1_hat =  [1.] [[0.96]]
</pre></div>
</div>
</div>
</div>
<p>Let’s compare the preceding population mean and variance with outcomes
from drawing a large sample and then regressing <span class="math notranslate nohighlight">\(z_1 - \mu_1\)</span> on
<span class="math notranslate nohighlight">\(z_2 - \mu_2\)</span>.</p>
<p>We know that</p>
<div class="math notranslate nohighlight">
\[
E z_1 | z_2 = \left(\mu_1 - \beta \mu_2 \right) + \beta z_2
\]</div>
<p>which can be arranged to</p>
<div class="math notranslate nohighlight">
\[
z_1 - \mu_1 = \beta \left( z_2 - \mu_2 \right) + \epsilon,
\]</div>
<p>We anticipate that for larger and larger sample sizes, estimated OLS
coefficients will converge to <span class="math notranslate nohighlight">\(\beta\)</span> and the estimated variance
of <span class="math notranslate nohighlight">\(\epsilon\)</span> will converge to <span class="math notranslate nohighlight">\(\hat{\Sigma}_1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span> <span class="c1"># sample size</span>

<span class="c1"># simulate multivariate normal random vectors</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">z1_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">z2_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># OLS regression</span>
<span class="n">μ1</span><span class="p">,</span> <span class="n">μ2</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">μs</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">z1_data</span> <span class="o">-</span> <span class="n">μ1</span><span class="p">,</span> <span class="n">z2_data</span> <span class="o">-</span> <span class="n">μ2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s compare the preceding population <span class="math notranslate nohighlight">\(\beta\)</span> with the OLS sample
estimate on <span class="math notranslate nohighlight">\(z_2 - \mu_2\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal</span><span class="o">.</span><span class="n">βs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.2]]), array([0.19931948]))
</pre></div>
</div>
</div>
</div>
<p>Let’s compare our population <span class="math notranslate nohighlight">\(\hat{\Sigma}_1\)</span> with the
degrees-of-freedom adjusted estimate of the variance of <span class="math notranslate nohighlight">\(\epsilon\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Σ1_hat</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resid</span> <span class="o">@</span> <span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.96]]), 0.9587665691312542)
</pre></div>
</div>
</div>
</div>
<p>Lastly, let’s compute the estimate of <span class="math notranslate nohighlight">\(\hat{E z_1 | z_2}\)</span> and
compare it with <span class="math notranslate nohighlight">\(\hat{\mu}_1\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ1_hat</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">μ2</span><span class="p">)</span> <span class="o">+</span> <span class="n">μ1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([1.]), array([0.99659739]))
</pre></div>
</div>
</div>
</div>
<p>Thus, in each case, for our very large sample size, the sample analogues
closely approximate their population counterparts.</p>
<p>These close approximations are foretold by a version of a Law of Large
Numbers.</p>
</section>
<section id="trivariate-example">
<h2><a class="toc-backref" href="#id5"><span class="section-number">12.4. </span>Trivariate Example</a><a class="headerlink" href="#trivariate-example" title="Permalink to this headline">¶</a></h2>
<p>Let’s apply our code to a trivariate example.</p>
<p>We’ll specify the mean vector and the covariance matrix as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">Σ</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span> <span class="c1"># positive semi-definite</span>

<span class="n">multi_normal</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.87686042, 0.29240495, 0.52145973]),
 array([[0.49231845, 0.58873992, 0.31839878],
        [0.58873992, 1.12164933, 0.55824919],
        [0.31839878, 0.55824919, 0.29990927]]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">multi_normal</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s compute the distribution of <span class="math notranslate nohighlight">\(z_1\)</span> conditional on
<span class="math notranslate nohighlight">\(z_{2}=\left[\begin{array}{c} 2\\ 5 \end{array}\right]\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">])</span>

<span class="n">μ1_hat</span><span class="p">,</span> <span class="n">Σ1_hat</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">z1_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span>
<span class="n">z2_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ1</span><span class="p">,</span> <span class="n">μ2</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">μs</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">z1_data</span> <span class="o">-</span> <span class="n">μ1</span><span class="p">,</span> <span class="n">z2_data</span> <span class="o">-</span> <span class="n">μ2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>As above, we compare population and sample regression coefficients, the
conditional covariance matrix, and the conditional mean vector in that
order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal</span><span class="o">.</span><span class="n">βs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[-0.04756601,  1.15018941]]), array([-0.04686309,  1.14877303]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Σ1_hat</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resid</span> <span class="o">@</span> <span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.15410356]]), 0.15417963558194095)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ1_hat</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">μ2</span><span class="p">)</span> <span class="o">+</span> <span class="n">μ1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([5.94680653]), array([5.94166352]))
</pre></div>
</div>
</div>
</div>
<p>Once again, sample analogues do a good job of approximating their
populations counterparts.</p>
</section>
<section id="one-dimensional-intelligence-iq">
<h2><a class="toc-backref" href="#id6"><span class="section-number">12.5. </span>One Dimensional Intelligence (IQ)</a><a class="headerlink" href="#one-dimensional-intelligence-iq" title="Permalink to this headline">¶</a></h2>
<p>Let’s move closer to a real-life example, namely, inferring a
one-dimensional measure of intelligence called IQ from a list of test
scores.</p>
<p>The <span class="math notranslate nohighlight">\(i\)</span>th test score <span class="math notranslate nohighlight">\(y_i\)</span> equals the sum of an unknown
scalar IQ <span class="math notranslate nohighlight">\(\theta\)</span> and a random variable <span class="math notranslate nohighlight">\(w_{i}\)</span>.</p>
<div class="math notranslate nohighlight">
\[
y_{i} = \theta + \sigma_y w_i, \quad i=1,\dots, n
\]</div>
<p>The distribution of IQ’s for a cross-section of people is a normal
random variable described by</p>
<div class="math notranslate nohighlight">
\[
\theta = \mu_{\theta} + \sigma_{\theta} w_{n+1}.
\]</div>
<p>We assume the noise in the test scores is IID and not correlated with
IQ.</p>
<p>In particular, we assume <span class="math notranslate nohighlight">\(\{w_i\}_{i=1}^{n+1}\)</span> are i.i.d. standard
normal:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\boldsymbol{w}=
\left[\begin{array}{c}
w_{1}\\
w_{2}\\
\vdots\\
w_{n}\\
w_{n+1}
\end{array}\right]\sim N\left(0,I_{n+1}\right)
\end{split}\]</div>
<p>The following system describes the random vector <span class="math notranslate nohighlight">\(X\)</span> that
interests us:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
X=\left[\begin{array}{c}
y_{1}\\
y_{2}\\
\vdots\\
y_{n}\\
\theta
\end{array}\right]=\left[\begin{array}{c}
\mu_{\theta}\\
\mu_{\theta}\\
\vdots\\
\mu_{\theta}\\
\mu_{\theta}
\end{array}\right]+\left[\begin{array}{ccccc}
\sigma_{y} &amp; 0 &amp; \cdots &amp; 0 &amp; \sigma_{\theta}\\
0 &amp; \sigma_{y} &amp; \cdots &amp; 0 &amp; \sigma_{\theta}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots\\
0 &amp; 0 &amp; \cdots &amp; \sigma_{y} &amp; \sigma_{\theta}\\
0 &amp; 0 &amp; \cdots &amp; 0 &amp; \sigma_{\theta}
\end{array}\right]\left[\begin{array}{c}
w_{1}\\
w_{2}\\
\vdots\\
w_{n}\\
w_{n+1}
\end{array}\right],
\end{split}\]</div>
<p>or equivalently,</p>
<div class="math notranslate nohighlight">
\[
X=\mu_{\theta}\boldsymbol{1}_{n+1}+D\boldsymbol{w}
\]</div>
<p>where <span class="math notranslate nohighlight">\(X = \begin{bmatrix} y \cr \theta \end{bmatrix}\)</span>,
<span class="math notranslate nohighlight">\(\boldsymbol{1}_{n+1}\)</span> is a vector of <span class="math notranslate nohighlight">\(1\)</span>s of size
<span class="math notranslate nohighlight">\(n+1\)</span>, and <span class="math notranslate nohighlight">\(D\)</span> is an <span class="math notranslate nohighlight">\(n+1\)</span> by <span class="math notranslate nohighlight">\(n+1\)</span> matrix.</p>
<p>Let’s define a Python function that constructs the mean <span class="math notranslate nohighlight">\(\mu\)</span> and
covariance matrix <span class="math notranslate nohighlight">\(\Sigma\)</span> of the random vector <span class="math notranslate nohighlight">\(X\)</span> that we
know is governed by a multivariate normal distribution.</p>
<p>As arguments, the function takes the number of tests <span class="math notranslate nohighlight">\(n\)</span>, the mean
<span class="math notranslate nohighlight">\(\mu_{\theta}\)</span> and the standard deviation <span class="math notranslate nohighlight">\(\sigma_\theta\)</span> of
the IQ distribution, and the standard deviation of the randomness in
test scores <span class="math notranslate nohighlight">\(\sigma_{y}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">construct_moments_IQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">σy</span><span class="p">):</span>

    <span class="n">μ_IQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">μθ</span><span class="p">)</span>

    <span class="n">D_IQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">D_IQ</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">σy</span>
    <span class="n">D_IQ</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">σθ</span>

    <span class="n">Σ_IQ</span> <span class="o">=</span> <span class="n">D_IQ</span> <span class="o">@</span> <span class="n">D_IQ</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">μ_IQ</span><span class="p">,</span> <span class="n">Σ_IQ</span><span class="p">,</span> <span class="n">D_IQ</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s consider a specific instance of this model.</p>
<p>Assume we have recorded <span class="math notranslate nohighlight">\(50\)</span> test scores and we know that
<span class="math notranslate nohighlight">\(\mu_{\theta}=100\)</span>, <span class="math notranslate nohighlight">\(\sigma_{\theta}=10\)</span>, and
<span class="math notranslate nohighlight">\(\sigma_{y}=10\)</span>.</p>
<p>We can compute the mean vector and covariance matrix of <span class="math notranslate nohighlight">\(x\)</span> easily
with our <code class="docutils literal notranslate"><span class="pre">construct_moments_IQ</span></code> function as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">σy</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span>

<span class="n">μ_IQ</span><span class="p">,</span> <span class="n">Σ_IQ</span><span class="p">,</span> <span class="n">D_IQ</span> <span class="o">=</span> <span class="n">construct_moments_IQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">σy</span><span class="p">)</span>
<span class="n">μ_IQ</span><span class="p">,</span> <span class="n">Σ_IQ</span><span class="p">,</span> <span class="n">D_IQ</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([100., 100., 100., 100., 100., 100., 100., 100., 100., 100., 100.,
        100., 100., 100., 100., 100., 100., 100., 100., 100., 100., 100.,
        100., 100., 100., 100., 100., 100., 100., 100., 100., 100., 100.,
        100., 100., 100., 100., 100., 100., 100., 100., 100., 100., 100.,
        100., 100., 100., 100., 100., 100., 100.]),
 array([[200., 100., 100., ..., 100., 100., 100.],
        [100., 200., 100., ..., 100., 100., 100.],
        [100., 100., 200., ..., 100., 100., 100.],
        ...,
        [100., 100., 100., ..., 200., 100., 100.],
        [100., 100., 100., ..., 100., 200., 100.],
        [100., 100., 100., ..., 100., 100., 100.]]),
 array([[10.,  0.,  0., ...,  0.,  0., 10.],
        [ 0., 10.,  0., ...,  0.,  0., 10.],
        [ 0.,  0., 10., ...,  0.,  0., 10.],
        ...,
        [ 0.,  0.,  0., ..., 10.,  0., 10.],
        [ 0.,  0.,  0., ...,  0., 10., 10.],
        [ 0.,  0.,  0., ...,  0.,  0., 10.]]))
</pre></div>
</div>
</div>
</div>
<p>We can now use our <code class="docutils literal notranslate"><span class="pre">MultivariateNormal</span></code> class to construct an
instance, then partition the mean vector and covariance matrix as we
wish.</p>
<p>We choose <code class="docutils literal notranslate"><span class="pre">k=n</span></code> so that <span class="math notranslate nohighlight">\(z_{1} = y\)</span> and <span class="math notranslate nohighlight">\(z_{2} = \theta\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_IQ</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ_IQ</span><span class="p">,</span> <span class="n">Σ_IQ</span><span class="p">)</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">n</span>
<span class="n">multi_normal_IQ</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using the generator <code class="docutils literal notranslate"><span class="pre">multivariate_normal</span></code>, we can make one draw of the
random vector from our distribution and then compute the distribution of
<span class="math notranslate nohighlight">\(\theta\)</span> conditional on our test scores.</p>
<p>Let’s do that and then print out some pertinent quantities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μ_IQ</span><span class="p">,</span> <span class="n">Σ_IQ</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># test scores</span>
<span class="n">θ</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># IQ</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the true value</span>
<span class="n">θ</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>84.81283802364857
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">cond_dist</span></code> takes test scores as input and returns the
conditional normal distribution of the IQ <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<p>Note that now <span class="math notranslate nohighlight">\(\theta\)</span> is what we denoted as <span class="math notranslate nohighlight">\(z_{2}\)</span> in the
general case so we need to set <code class="docutils literal notranslate"><span class="pre">ind=1</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">multi_normal_IQ</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([85.70096716]), array([[1.96078431]]))
</pre></div>
</div>
</div>
</div>
<p>The first number is the conditional mean <span class="math notranslate nohighlight">\(\hat{\mu}_{\theta}\)</span> and
the second is the conditional variance <span class="math notranslate nohighlight">\(\hat{\Sigma}_{\theta}\)</span>.</p>
<p>How do the additional test scores affect our inferences?</p>
<p>To shed light on this, we compute a sequence of conditional
distributions of <span class="math notranslate nohighlight">\(\theta\)</span> by varying the number of test scores in
the conditioning set from <span class="math notranslate nohighlight">\(1\)</span> to <span class="math notranslate nohighlight">\(n\)</span>.</p>
<p>We’ll make a pretty graph showing how our judgment of the person’s IQ
change as more test results come in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># array for containing moments</span>
<span class="n">μθ_hat_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">Σθ_hat_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># loop over number of test scores</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># construction of multivariate normal distribution instance</span>
    <span class="n">μ_IQ_i</span><span class="p">,</span> <span class="n">Σ_IQ_i</span><span class="p">,</span> <span class="n">D_IQ_i</span> <span class="o">=</span> <span class="n">construct_moments_IQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">σy</span><span class="p">)</span>
    <span class="n">multi_normal_IQ_i</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ_IQ_i</span><span class="p">,</span> <span class="n">Σ_IQ_i</span><span class="p">)</span>

    <span class="c1"># partition and compute conditional distribution</span>
    <span class="n">multi_normal_IQ_i</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">scores_i</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">μθ_hat_i</span><span class="p">,</span> <span class="n">Σθ_hat_i</span> <span class="o">=</span> <span class="n">multi_normal_IQ_i</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scores_i</span><span class="p">)</span>

    <span class="c1"># store the results</span>
    <span class="n">μθ_hat_arr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">μθ_hat_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Σθ_hat_arr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σθ_hat_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># transform variance to standard deviation</span>
<span class="n">σθ_hat_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Σθ_hat_arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μθ_hat_lower</span> <span class="o">=</span> <span class="n">μθ_hat_arr</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">σθ_hat_arr</span>
<span class="n">μθ_hat_higher</span> <span class="o">=</span> <span class="n">μθ_hat_arr</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">σθ_hat_arr</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">θ</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;true $θ$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">μθ_hat_arr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\hat</span><span class="si">{μ}</span><span class="s1">_</span><span class="si">{θ}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">μθ_hat_lower</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">μθ_hat_higher</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">μθ_hat_lower</span><span class="p">,</span> <span class="n">μθ_hat_higher</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95%&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of test scores&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\hat</span><span class="si">{θ}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/multivariate_normal_44_0.png" src="_images/multivariate_normal_44_0.png" />
</div>
</div>
<p>The solid blue line in the plot above shows <span class="math notranslate nohighlight">\(\hat{\mu}_{\theta}\)</span>
as a function of the number of test scores that we have recorded and
conditioned on.</p>
<p>The blue area shows the span that comes from adding or deducing
<span class="math notranslate nohighlight">\(1.96 \hat{\sigma}_{\theta}\)</span> from <span class="math notranslate nohighlight">\(\hat{\mu}_{\theta}\)</span>.</p>
<p>Therefore, <span class="math notranslate nohighlight">\(95\%\)</span> of the probability mass of the conditional
distribution falls in this range.</p>
<p>The value of the random <span class="math notranslate nohighlight">\(\theta\)</span> that we drew is shown by the
black dotted line.</p>
<p>As more and more test scores come in, our estimate of the person’s
<span class="math notranslate nohighlight">\(\theta\)</span> become more and more reliable.</p>
<p>By staring at the changes in the conditional distributions, we see that
adding more test scores makes <span class="math notranslate nohighlight">\(\hat{\theta}\)</span> settle down and
approach <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<p>Thus, each <span class="math notranslate nohighlight">\(y_{i}\)</span> adds information about <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<p>If we drove the number of tests <span class="math notranslate nohighlight">\(n \rightarrow + \infty\)</span>, the
conditional standard deviation <span class="math notranslate nohighlight">\(\hat{\sigma}_{\theta}\)</span> would
converge to <span class="math notranslate nohighlight">\(0\)</span> at the rate <span class="math notranslate nohighlight">\(\frac{1}{n^{.5}}\)</span>.</p>
</section>
<section id="another-representation">
<h2><a class="toc-backref" href="#id7"><span class="section-number">12.6. </span>Another representation</a><a class="headerlink" href="#another-representation" title="Permalink to this headline">¶</a></h2>
<p>By using a different representation, let’s look at things from a
different perspective.</p>
<p>We can represent the random vector <span class="math notranslate nohighlight">\(X\)</span> defined above as</p>
<div class="math notranslate nohighlight">
\[
X = \mu_{\theta} \boldsymbol{1}_{n+1} + C \epsilon, \quad \epsilon \sim N\left(0, I\right)
\]</div>
<p>where <span class="math notranslate nohighlight">\(C\)</span> is a lower triangular <strong>Cholesky factor</strong> of
<span class="math notranslate nohighlight">\(\Sigma\)</span> so that</p>
<div class="math notranslate nohighlight">
\[
\Sigma \equiv DD^{\prime} = C C^\prime
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
E \epsilon \epsilon' = I .
\]</div>
<p>It follows that</p>
<div class="math notranslate nohighlight">
\[
\epsilon \sim N(0, I) .
\]</div>
<p>Let <span class="math notranslate nohighlight">\(G=C^{-1}\)</span>; <span class="math notranslate nohighlight">\(G\)</span> is also lower triangular.</p>
<p>We can compute <span class="math notranslate nohighlight">\(\epsilon\)</span> from the formula</p>
<div class="math notranslate nohighlight">
\[
\epsilon = G \left( X - \mu_{\theta} \boldsymbol{1}_{n+1} \right)
\]</div>
<p>This formula confirms that the orthonormal vector <span class="math notranslate nohighlight">\(\epsilon\)</span>
contains the same information as the non-orthogonal vector
<span class="math notranslate nohighlight">\(\left( X - \mu_{\theta} \boldsymbol{1}_{n+1} \right)\)</span>.</p>
<p>We can say that <span class="math notranslate nohighlight">\(\epsilon\)</span> is an orthogonal basis for
<span class="math notranslate nohighlight">\(\left( X - \mu_{\theta} \boldsymbol{1}_{n+1} \right)\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(c_{i}\)</span> be the <span class="math notranslate nohighlight">\(i\)</span>th element in the last row of
<span class="math notranslate nohighlight">\(C\)</span>.</p>
<p>Then we can write</p>
<div class="math notranslate nohighlight" id="equation-mnv-1">
<span class="eqno">(12.1)<a class="headerlink" href="#equation-mnv-1" title="Permalink to this equation">¶</a></span>\[\theta = \mu_{\theta} + c_1 \epsilon_1 + c_2 \epsilon_2 + \dots + c_n \epsilon_n + c_{n+1} \epsilon_{n+1}\]</div>
<p>The mutual orthogonality of the <span class="math notranslate nohighlight">\(\epsilon_i\)</span>’s provides us with an
informative way to interpret them in light of equation <a class="reference internal" href="#equation-mnv-1">(12.1)</a>.</p>
<p>Thus, relative to what is known from tests <span class="math notranslate nohighlight">\(i=1, \ldots, n-1\)</span>,
<span class="math notranslate nohighlight">\(c_i \epsilon_i\)</span> is the amount of <strong>new information</strong> about
<span class="math notranslate nohighlight">\(\theta\)</span> brought by the test number <span class="math notranslate nohighlight">\(i\)</span>.</p>
<p>Here <strong>new information</strong> means <strong>surprise</strong> or what could not be
predicted from earlier information.</p>
<p>Formula <a class="reference internal" href="#equation-mnv-1">(12.1)</a> also provides us with an enlightening way to express
conditional means and conditional variances that we computed earlier.</p>
<p>In particular,</p>
<div class="math notranslate nohighlight">
\[
E\left[\theta \mid y_1, \dots, y_k\right] = \mu_{\theta} + c_1 \epsilon_1 + \dots + c_k \epsilon_k
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
Var\left(\theta \mid y_1, \dots, y_k\right) = c^2_{k+1} + c^2_{k+2} + \dots + c^2_{n+1}.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Σ_IQ</span><span class="p">)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>

<span class="n">ε</span> <span class="o">=</span> <span class="n">G</span> <span class="o">@</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">μθ</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cε</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ε</span>

<span class="c1"># compute the sequence of μθ and Σθ conditional on y1, y2, ..., yk</span>
<span class="n">μθ_hat_arr_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cε</span><span class="p">[:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span> <span class="o">+</span> <span class="n">μθ</span>
<span class="n">Σθ_hat_arr_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<p>To confirm that these formulas give the same answers that we computed
earlier, we can compare the means and variances of <span class="math notranslate nohighlight">\(\theta\)</span>
conditional on <span class="math notranslate nohighlight">\(\{y_i\}_{i=1}^k\)</span> with what we obtained above using
the formulas implemented in the class <code class="docutils literal notranslate"><span class="pre">MultivariateNormal</span></code> built on
our original representation of conditional distributions for
multivariate normal distributions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># conditional mean</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">μθ_hat_arr</span> <span class="o">-</span> <span class="n">μθ_hat_arr_C</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># conditional variance</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Σθ_hat_arr</span> <span class="o">-</span> <span class="n">Σθ_hat_arr_C</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="magic-of-the-cholesky-factorization">
<h2><a class="toc-backref" href="#id8"><span class="section-number">12.7. </span>Magic of the Cholesky factorization</a><a class="headerlink" href="#magic-of-the-cholesky-factorization" title="Permalink to this headline">¶</a></h2>
<p>Evidently, the Cholesky factorization is automatically computing the
population  <strong>regression coefficients</strong> and associated statistics
that are produced by our <code class="docutils literal notranslate"><span class="pre">MultivariateNormal</span></code> class.</p>
<p>The Cholesky factorization is  computing things <strong>recursively</strong>.</p>
<p>Indeed, in formula <a class="reference internal" href="#equation-mnv-1">(12.1)</a>,</p>
<ul class="simple">
<li><p>the random variable <span class="math notranslate nohighlight">\(c_i \epsilon_i\)</span> is information about
<span class="math notranslate nohighlight">\(\theta\)</span> that is not contained by the information in
<span class="math notranslate nohighlight">\(\epsilon_1, \epsilon_2, \ldots, \epsilon_{i-1}\)</span></p></li>
<li><p>the coefficient <span class="math notranslate nohighlight">\(c_i\)</span> is the simple population regression
coefficient of <span class="math notranslate nohighlight">\(\theta - \mu_\theta\)</span> on <span class="math notranslate nohighlight">\(\epsilon_i\)</span></p></li>
</ul>
</section>
<section id="math-and-verbal-components-of-intelligence">
<h2><a class="toc-backref" href="#id9"><span class="section-number">12.8. </span>Math and Verbal Components of Intelligence</a><a class="headerlink" href="#math-and-verbal-components-of-intelligence" title="Permalink to this headline">¶</a></h2>
<p>We can alter the preceding example to be more realistic.</p>
<p>There is ample evidence that IQ is not a scalar.</p>
<p>Some people are good in math skills but poor in language skills.</p>
<p>Other people are good in language skills but poor in math skills.</p>
<p>So now we shall assume that there are two dimensions of IQ,
<span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(\eta\)</span>.</p>
<p>These determine average performances in math and language tests,
respectively.</p>
<p>We observe math scores <span class="math notranslate nohighlight">\(\{y_i\}_{i=1}^{n}\)</span> and language scores
<span class="math notranslate nohighlight">\(\{y_i\}_{i=n+1}^{2n}\)</span>.</p>
<p>When <span class="math notranslate nohighlight">\(n=2\)</span>, we assume that outcomes are draws from a multivariate
normal distribution with representation</p>
<div class="math notranslate nohighlight">
\[\begin{split}
X=\left[\begin{array}{c}
y_{1}\\
y_{2}\\
y_{3}\\
y_{4}\\
\theta\\
\eta
\end{array}\right]=\left[\begin{array}{c}
\mu_{\theta}\\
\mu_{\theta}\\
\mu_{\eta}\\
\mu_{\eta}\\
\mu_{\theta}\\
\mu_{\eta}
\end{array}\right]+\left[\begin{array}{cccccc}
\sigma_{y} &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_{\theta} &amp; 0\\
0 &amp; \sigma_{y} &amp; 0 &amp; 0 &amp; \sigma_{\theta} &amp; 0\\
0 &amp; 0 &amp; \sigma_{y} &amp; 0 &amp; 0 &amp; \sigma_{\eta}\\
0 &amp; 0 &amp; 0 &amp; \sigma_{y} &amp; 0 &amp; \sigma_{\eta}\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_{\theta} &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_{\eta}
\end{array}\right]\left[\begin{array}{c}
w_{1}\\
w_{2}\\
w_{3}\\
w_{4}\\
w_{5}\\
w_{6}
\end{array}\right]
\end{split}\]</div>
<p>where
<span class="math notranslate nohighlight">\(w \begin{bmatrix} w_1 \cr w_2 \cr \vdots \cr w_6 \end{bmatrix}\)</span>
is a standard normal random vector.</p>
<p>We construct a Python function <code class="docutils literal notranslate"><span class="pre">construct_moments_IQ2d</span></code> to construct
the mean vector and covariance matrix of the joint normal distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">construct_moments_IQ2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">μη</span><span class="p">,</span> <span class="n">ση</span><span class="p">,</span> <span class="n">σy</span><span class="p">):</span>

    <span class="n">μ_IQ2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">μ_IQ2d</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">μθ</span>
    <span class="n">μ_IQ2d</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">μθ</span>
    <span class="n">μ_IQ2d</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">μη</span>
    <span class="n">μ_IQ2d</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">μη</span>


    <span class="n">D_IQ2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">D_IQ2d</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">σy</span>
    <span class="n">D_IQ2d</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">σθ</span>
    <span class="n">D_IQ2d</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">σθ</span>
    <span class="n">D_IQ2d</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ση</span>
    <span class="n">D_IQ2d</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ση</span>

    <span class="n">Σ_IQ2d</span> <span class="o">=</span> <span class="n">D_IQ2d</span> <span class="o">@</span> <span class="n">D_IQ2d</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">μ_IQ2d</span><span class="p">,</span> <span class="n">Σ_IQ2d</span><span class="p">,</span> <span class="n">D_IQ2d</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s put the function to work.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># mean and variance of θ, η, and y</span>
<span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">μη</span><span class="p">,</span> <span class="n">ση</span><span class="p">,</span> <span class="n">σy</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>

<span class="n">μ_IQ2d</span><span class="p">,</span> <span class="n">Σ_IQ2d</span><span class="p">,</span> <span class="n">D_IQ2d</span> <span class="o">=</span> <span class="n">construct_moments_IQ2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">μθ</span><span class="p">,</span> <span class="n">σθ</span><span class="p">,</span> <span class="n">μη</span><span class="p">,</span> <span class="n">ση</span><span class="p">,</span> <span class="n">σy</span><span class="p">)</span>
<span class="n">μ_IQ2d</span><span class="p">,</span> <span class="n">Σ_IQ2d</span><span class="p">,</span> <span class="n">D_IQ2d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([100., 100., 100., 100., 100., 100.]),
 array([[200., 100.,   0.,   0., 100.,   0.],
        [100., 200.,   0.,   0., 100.,   0.],
        [  0.,   0., 200., 100.,   0., 100.],
        [  0.,   0., 100., 200.,   0., 100.],
        [100., 100.,   0.,   0., 100.,   0.],
        [  0.,   0., 100., 100.,   0., 100.]]),
 array([[10.,  0.,  0.,  0., 10.,  0.],
        [ 0., 10.,  0.,  0., 10.,  0.],
        [ 0.,  0., 10.,  0.,  0., 10.],
        [ 0.,  0.,  0., 10.,  0., 10.],
        [ 0.,  0.,  0.,  0., 10.,  0.],
        [ 0.,  0.,  0.,  0.,  0., 10.]]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># take one draw</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μ_IQ2d</span><span class="p">,</span> <span class="n">Σ_IQ2d</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
<span class="n">θ</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
<span class="n">η</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># the true values</span>
<span class="n">θ</span><span class="p">,</span> <span class="n">η</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(107.1767512282239, 107.4902517894457)
</pre></div>
</div>
</div>
</div>
<p>We first compute the joint normal distribution of
<span class="math notranslate nohighlight">\(\left(\theta, \eta\right)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_IQ2d</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ_IQ2d</span><span class="p">,</span> <span class="n">Σ_IQ2d</span><span class="p">)</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span> <span class="c1"># the length of data vector</span>
<span class="n">multi_normal_IQ2d</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

<span class="n">multi_normal_IQ2d</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">y1</span><span class="p">,</span> <span class="o">*</span><span class="n">y2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([115.55481925, 110.94510287]),
 array([[33.33333333,  0.        ],
        [ 0.        , 33.33333333]]))
</pre></div>
</div>
</div>
</div>
<p>Now let’s compute distributions of <span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(\mu\)</span>
separately conditional on various subsets of test scores.</p>
<p>It will be fun to compare outcomes with the help of an auxiliary function
<code class="docutils literal notranslate"><span class="pre">cond_dist_IQ2d</span></code> that we now construct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cond_dist_IQ2d</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>

    <span class="n">multi_normal</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">)</span>
    <span class="n">multi_normal</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">μ_hat</span><span class="p">,</span> <span class="n">Σ_hat</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">μ_hat</span><span class="p">,</span> <span class="n">Σ_hat</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see how things work for an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">indices</span><span class="p">,</span> <span class="n">IQ</span><span class="p">,</span> <span class="n">conditions</span> <span class="ow">in</span> <span class="p">[([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="s1">&#39;y1, y2, y3, y4&#39;</span><span class="p">),</span>
                                <span class="p">([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="s1">&#39;y1, y2&#39;</span><span class="p">),</span>
                                <span class="p">([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="s1">&#39;y3, y4&#39;</span><span class="p">),</span>
                                <span class="p">([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;η&#39;</span><span class="p">,</span> <span class="s1">&#39;y1, y2, y3, y4&#39;</span><span class="p">),</span>
                                <span class="p">([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;η&#39;</span><span class="p">,</span> <span class="s1">&#39;y1, y2&#39;</span><span class="p">),</span>
                                <span class="p">([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;η&#39;</span><span class="p">,</span> <span class="s1">&#39;y3, y4&#39;</span><span class="p">)]:</span>

    <span class="n">μ_hat</span><span class="p">,</span> <span class="n">Σ_hat</span> <span class="o">=</span> <span class="n">cond_dist_IQ2d</span><span class="p">(</span><span class="n">μ_IQ2d</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">Σ_IQ2d</span><span class="p">[</span><span class="n">indices</span><span class="p">][:,</span> <span class="n">indices</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mean and variance of </span><span class="si">{</span><span class="n">IQ</span><span class="si">}</span><span class="s1"> conditional on </span><span class="si">{</span><span class="n">conditions</span><span class="si">:</span><span class="s1"> &lt;15</span><span class="si">}</span><span class="s1"> are &#39;</span> <span class="o">+</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">μ_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">1.2f</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">Σ_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">1.2f</span><span class="si">}</span><span class="s1"> respectively&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The mean and variance of θ conditional on y1, y2, y3, y4  are 115.55 and 33.33 respectively
The mean and variance of θ conditional on y1, y2          are 115.55 and 33.33 respectively
The mean and variance of θ conditional on y3, y4          are 100.00 and 100.00 respectively
The mean and variance of η conditional on y1, y2, y3, y4  are 110.95 and 33.33 respectively
The mean and variance of η conditional on y1, y2          are 100.00 and 100.00 respectively
The mean and variance of η conditional on y3, y4          are 110.95 and 33.33 respectively
</pre></div>
</div>
</div>
</div>
<p>Evidently, math tests provide no information about <span class="math notranslate nohighlight">\(\mu\)</span> and
language tests provide no information about <span class="math notranslate nohighlight">\(\eta\)</span>.</p>
</section>
<section id="univariate-time-series-analysis">
<h2><a class="toc-backref" href="#id10"><span class="section-number">12.9. </span>Univariate Time Series Analysis</a><a class="headerlink" href="#univariate-time-series-analysis" title="Permalink to this headline">¶</a></h2>
<p>We can use the multivariate normal distribution and a little matrix
algebra to present foundations of univariate linear time series
analysis.</p>
<p>Let <span class="math notranslate nohighlight">\(x_t, y_t, v_t, w_{t+1}\)</span> each be scalars for <span class="math notranslate nohighlight">\(t \geq 0\)</span>.</p>
<p>Consider the following model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
x_0 &amp; \sim  N\left(0, \sigma_0^2\right) \\
x_{t+1} &amp; = a x_{t} + b w_{t+1}, \quad w_{t+1} \sim N\left(0, 1\right), t \geq 0  \\
y_{t} &amp; = c x_{t} + d v_{t}, \quad v_{t} \sim N\left(0, 1\right), t \geq 0
\end{aligned}
\end{split}\]</div>
<p>We can compute the moments of <span class="math notranslate nohighlight">\(x_{t}\)</span></p>
<ol class="simple">
<li><p><span class="math notranslate nohighlight">\(E x_{t+1}^2 = a^2 E x_{t}^2 + b^2, t \geq 0\)</span>, where
<span class="math notranslate nohighlight">\(E x_{0}^2 = \sigma_{0}^2\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(E x_{t+j} x_{t} = a^{j} E x_{t}^2, \forall t \ \forall j\)</span></p></li>
</ol>
<p>Given some <span class="math notranslate nohighlight">\(T\)</span>, we can formulate the sequence
<span class="math notranslate nohighlight">\(\{x_{t}\}_{t=0}^T\)</span> as a random vector</p>
<div class="math notranslate nohighlight">
\[\begin{split}
X=\left[\begin{array}{c}
x_{0}\\
x_{1}\\
\vdots\\
x_{T}
\end{array}\right]
\end{split}\]</div>
<p>and the covariance matrix <span class="math notranslate nohighlight">\(\Sigma_{x}\)</span> can be constructed using
the moments we have computed above.</p>
<p>Similarly, we can define</p>
<div class="math notranslate nohighlight">
\[\begin{split}
Y=\left[\begin{array}{c}
y_{0}\\
y_{1}\\
\vdots\\
y_{T}
\end{array}\right], \quad
v=\left[\begin{array}{c}
v_{0}\\
v_{1}\\
\vdots\\
v_{T}
\end{array}\right]
\end{split}\]</div>
<p>and therefore</p>
<div class="math notranslate nohighlight">
\[
Y = C X + D V
\]</div>
<p>where <span class="math notranslate nohighlight">\(C\)</span> and <span class="math notranslate nohighlight">\(D\)</span> are both diagonal matrices with constant
<span class="math notranslate nohighlight">\(c\)</span> and <span class="math notranslate nohighlight">\(d\)</span> as diagonal respectively.</p>
<p>Consequently, the covariance matrix of <span class="math notranslate nohighlight">\(Y\)</span> is</p>
<div class="math notranslate nohighlight">
\[
\Sigma_{y} = E Y Y^{\prime} = C \Sigma_{x} C^{\prime} + D D^{\prime}
\]</div>
<p>By stacking <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span>, we can write</p>
<div class="math notranslate nohighlight">
\[\begin{split}
Z=\left[\begin{array}{c}
X\\
Y
\end{array}\right]
\end{split}\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\Sigma_{z} = EZZ^{\prime}=\left[\begin{array}{cc}
\Sigma_{x} &amp; \Sigma_{x}C^{\prime}\\
C\Sigma_{x} &amp; \Sigma_{y}
\end{array}\right]
\end{split}\]</div>
<p>Thus, the stacked sequences <span class="math notranslate nohighlight">\(\{x_{t}\}_{t=0}^T\)</span> and
<span class="math notranslate nohighlight">\(\{y_{t}\}_{t=0}^T\)</span> jointly follow the multivariate normal
distribution <span class="math notranslate nohighlight">\(N\left(0, \Sigma_{z}\right)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># as an example, consider the case where T = 3</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># variance of the initial distribution x_0</span>
<span class="n">σ0</span> <span class="o">=</span> <span class="mf">1.</span>

<span class="c1"># parameters of the equation system</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">.9</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">.05</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the covariance matrix of X</span>
<span class="n">Σx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="n">Σx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">σ0</span> <span class="o">**</span> <span class="mi">2</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="n">Σx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
    <span class="n">Σx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">Σx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Σx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Σx</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.      , 0.9     , 0.81    , 0.729   ],
       [0.9     , 1.81    , 1.629   , 1.4661  ],
       [0.81    , 1.629   , 2.4661  , 2.21949 ],
       [0.729   , 1.4661  , 2.21949 , 2.997541]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the covariance matrix of Y</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span>

<span class="n">Σy</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">Σx</span> <span class="o">@</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">D</span> <span class="o">@</span> <span class="n">D</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the covariance matrix of Z</span>
<span class="n">Σz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

<span class="n">Σz</span><span class="p">[:</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σx</span>
<span class="n">Σz</span><span class="p">[:</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σx</span> <span class="o">@</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span>
<span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">Σx</span>
<span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Σz</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.      , 0.9     , 0.81    , 0.729   , 1.      , 0.9     ,
        0.81    , 0.729   ],
       [0.9     , 1.81    , 1.629   , 1.4661  , 0.9     , 1.81    ,
        1.629   , 1.4661  ],
       [0.81    , 1.629   , 2.4661  , 2.21949 , 0.81    , 1.629   ,
        2.4661  , 2.21949 ],
       [0.729   , 1.4661  , 2.21949 , 2.997541, 0.729   , 1.4661  ,
        2.21949 , 2.997541],
       [1.      , 0.9     , 0.81    , 0.729   , 1.0025  , 0.9     ,
        0.81    , 0.729   ],
       [0.9     , 1.81    , 1.629   , 1.4661  , 0.9     , 1.8125  ,
        1.629   , 1.4661  ],
       [0.81    , 1.629   , 2.4661  , 2.21949 , 0.81    , 1.629   ,
        2.4686  , 2.21949 ],
       [0.729   , 1.4661  , 2.21949 , 2.997541, 0.729   , 1.4661  ,
        2.21949 , 3.000041]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the mean vector of Z</span>
<span class="n">μz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The following Python code lets us sample random vectors <span class="math notranslate nohighlight">\(X\)</span> and
<span class="math notranslate nohighlight">\(Y\)</span>.</p>
<p>This is going to be very useful for doing the conditioning to be used in
the fun exercises below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μz</span><span class="p">,</span> <span class="n">Σz</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<section id="smoothing-example">
<h3><span class="section-number">12.9.1. </span>Smoothing Example<a class="headerlink" href="#smoothing-example" title="Permalink to this headline">¶</a></h3>
<p>This is an instance of a classic <code class="docutils literal notranslate"><span class="pre">smoothing</span></code> calculation whose purpose
is to compute <span class="math notranslate nohighlight">\(E X \mid Y\)</span>.</p>
<p>An interpretation of this example is</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(X\)</span> is a random sequence of hidden Markov state variables
<span class="math notranslate nohighlight">\(x_t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Y\)</span> is a sequence of observed signals <span class="math notranslate nohighlight">\(y_t\)</span> bearing
information about the hidden state</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct a MultivariateNormal instance</span>
<span class="n">multi_normal_ex1</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μz</span><span class="p">,</span> <span class="n">Σz</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># partition Z into X and Y</span>
<span class="n">multi_normal_ex1</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the conditional mean and covariance matrix of X given Y=y</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X = &quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Y = &quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; E [ X | Y] = &quot;</span><span class="p">,</span> <span class="p">)</span>

<span class="n">multi_normal_ex1</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X =  [ 0.27580476  0.27849496 -0.53010728 -0.61556326]
Y =  [ 0.34581721  0.31702906 -0.46995591 -0.65369484]
 E [ X | Y] = 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([ 0.34496572,  0.31532405, -0.46859555, -0.65311639]),
 array([[2.48875094e-03, 5.57449314e-06, 1.24861729e-08, 2.80235835e-11],
        [5.57449314e-06, 2.48876343e-03, 5.57452116e-06, 1.25113941e-08],
        [1.24861729e-08, 5.57452116e-06, 2.48876346e-03, 5.58575339e-06],
        [2.80235835e-11, 1.25113941e-08, 5.58575339e-06, 2.49377812e-03]]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="filtering-exercise">
<h3><span class="section-number">12.9.2. </span>Filtering Exercise<a class="headerlink" href="#filtering-exercise" title="Permalink to this headline">¶</a></h3>
<p>Compute <span class="math notranslate nohighlight">\(E\left[x_{t} \mid y_{t-1}, y_{t-2}, \dots, y_{0}\right]\)</span>.</p>
<p>To do so, we need to first construct the mean vector and the covariance
matrix of the subvector
<span class="math notranslate nohighlight">\(\left[x_{t}, y_{0}, \dots, y_{t-2}, y_{t-1}\right]\)</span>.</p>
<p>For example, let’s say that we want the conditional distribution of
<span class="math notranslate nohighlight">\(x_{3}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mean of the subvector</span>
<span class="n">sub_μz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># covariance matrix of the subvector</span>
<span class="n">sub_Σz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="c1"># x_t</span>
<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_Σz</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[2.997541, 0.729   , 1.4661  , 2.21949 ],
       [0.729   , 1.0025  , 0.9     , 0.81    ],
       [1.4661  , 0.9     , 1.8125  , 1.629   ],
       [2.21949 , 0.81    , 1.629   , 2.4686  ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_ex2</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">sub_μz</span><span class="p">,</span> <span class="n">sub_Σz</span><span class="p">)</span>
<span class="n">multi_normal_ex2</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">t</span><span class="p">]</span>

<span class="n">multi_normal_ex2</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sub_y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-0.42126861]), array([[1.00201996]]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="prediction-exercise">
<h3><span class="section-number">12.9.3. </span>Prediction Exercise<a class="headerlink" href="#prediction-exercise" title="Permalink to this headline">¶</a></h3>
<p>Compute <span class="math notranslate nohighlight">\(E\left[y_{t} \mid y_{t-j}, \dots, y_{0} \right]\)</span>.</p>
<p>As what we did in exercise 2, we will construct the mean vector and
covariance matrix of the subvector
<span class="math notranslate nohighlight">\(\left[y_{t}, y_{0}, \dots, y_{t-j-1}, y_{t-j} \right]\)</span>.</p>
<p>For example, we take a case in which <span class="math notranslate nohighlight">\(t=3\)</span> and <span class="math notranslate nohighlight">\(j=2\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">j</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_μz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sub_Σz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>

<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sub_Σz</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">+</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_Σz</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3.000041, 0.729   , 1.4661  ],
       [0.729   , 1.0025  , 0.9     ],
       [1.4661  , 0.9     , 1.8125  ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_ex3</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">sub_μz</span><span class="p">,</span> <span class="n">sub_Σz</span><span class="p">)</span>
<span class="n">multi_normal_ex3</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">t</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

<span class="n">multi_normal_ex3</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sub_y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.25678029]), array([[1.81413617]]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="constructing-a-wold-representation">
<h3><span class="section-number">12.9.4. </span>Constructing a Wold Representation<a class="headerlink" href="#constructing-a-wold-representation" title="Permalink to this headline">¶</a></h3>
<p>Now we’ll apply Cholesky decomposition to decompose
<span class="math notranslate nohighlight">\(\Sigma_{y}=H H^{\prime}\)</span> and form</p>
<div class="math notranslate nohighlight">
\[
\epsilon = H^{-1} Y.
\]</div>
<p>Then we can represent <span class="math notranslate nohighlight">\(y_{t}\)</span> as</p>
<div class="math notranslate nohighlight">
\[
y_{t} = h_{t,t} \epsilon_{t} + h_{t,t-1} \epsilon_{t-1} + \dots + h_{t,0} \epsilon_{0}.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Σy</span><span class="p">)</span>

<span class="n">H</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.00124922, 0.        , 0.        , 0.        ],
       [0.8988771 , 1.00225743, 0.        , 0.        ],
       [0.80898939, 0.89978675, 1.00225743, 0.        ],
       [0.72809046, 0.80980808, 0.89978676, 1.00225743]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ε</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">@</span> <span class="n">y</span>

<span class="n">ε</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.34538575,  0.00655492, -0.75356622, -0.23190272])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.34581721,  0.31702906, -0.46995591, -0.65369484])
</pre></div>
</div>
</div>
</div>
<p>This example is an instance of what is known as a <strong>Wold representation</strong> in time series analysis.</p>
</section>
</section>
<section id="classic-factor-analysis-model">
<h2><a class="toc-backref" href="#id11"><span class="section-number">12.10. </span>Classic Factor Analysis Model</a><a class="headerlink" href="#classic-factor-analysis-model" title="Permalink to this headline">¶</a></h2>
<p>The factor analysis model widely used in psychology and other fields can
be represented as</p>
<div class="math notranslate nohighlight">
\[
Y = \Lambda f + U
\]</div>
<p>where</p>
<ol class="simple">
<li><p><span class="math notranslate nohighlight">\(Y\)</span> is <span class="math notranslate nohighlight">\(n \times 1\)</span> random vector,
<span class="math notranslate nohighlight">\(E U U^{\prime} = D\)</span> is a diagonal matrix,</p></li>
<li><p><span class="math notranslate nohighlight">\(\Lambda\)</span> is <span class="math notranslate nohighlight">\(n \times k\)</span> coefficient matrix,</p></li>
<li><p><span class="math notranslate nohighlight">\(f\)</span> is <span class="math notranslate nohighlight">\(k \times 1\)</span> random vector,
<span class="math notranslate nohighlight">\(E f f^{\prime} = I\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(U\)</span> is <span class="math notranslate nohighlight">\(n \times 1\)</span> random vector, and <span class="math notranslate nohighlight">\(U \perp f\)</span>.</p></li>
<li><p>It is presumed that <span class="math notranslate nohighlight">\(k\)</span> is small relative to <span class="math notranslate nohighlight">\(n\)</span>; often
<span class="math notranslate nohighlight">\(k\)</span> is only <span class="math notranslate nohighlight">\(1\)</span> or <span class="math notranslate nohighlight">\(2\)</span>, as in our IQ examples.</p></li>
</ol>
<p>This implies that</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\Sigma_y = E Y Y^{\prime} = \Lambda \Lambda^{\prime} + D \\
E Y f^{\prime} = \Lambda \\
E f Y^{\prime} = \Lambda^{\prime}
\end{aligned}
\end{split}\]</div>
<p>Thus, the covariance matrix <span class="math notranslate nohighlight">\(\Sigma_Y\)</span> is the sum of a diagonal
matrix <span class="math notranslate nohighlight">\(D\)</span> and a positive semi-definite matrix
<span class="math notranslate nohighlight">\(\Lambda \Lambda^{\prime}\)</span> of rank <span class="math notranslate nohighlight">\(k\)</span>.</p>
<p>This means that all covariances among the <span class="math notranslate nohighlight">\(n\)</span> components of the
<span class="math notranslate nohighlight">\(Y\)</span> vector are intermediated by their common dependencies on the
<span class="math notranslate nohighlight">\(k&lt;\)</span> factors.</p>
<p>Form</p>
<div class="math notranslate nohighlight">
\[\begin{split}
Z=\left(\begin{array}{c}
f\\
Y
\end{array}\right)
\end{split}\]</div>
<p>the covariance matrix of the expanded random vector <span class="math notranslate nohighlight">\(Z\)</span> can be
computed as</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\Sigma_{z} = EZZ^{\prime}=\left(\begin{array}{cc}
I &amp; \Lambda^{\prime}\\
\Lambda &amp; \Lambda\Lambda^{\prime}+D
\end{array}\right)
\end{split}\]</div>
<p>In the following, we first construct the mean vector and the covariance
matrix for the case where <span class="math notranslate nohighlight">\(N=10\)</span> and <span class="math notranslate nohighlight">\(k=2\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>We set the coefficient matrix <span class="math notranslate nohighlight">\(\Lambda\)</span> and the covariance matrix
of <span class="math notranslate nohighlight">\(U\)</span> to be</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\Lambda=\left(\begin{array}{cc}
1 &amp; 0\\
\vdots &amp; \vdots\\
1 &amp; 0\\
0 &amp; 1\\
\vdots &amp; \vdots\\
0 &amp; 1
\end{array}\right),\quad D=\left(\begin{array}{cccc}
\sigma_{u}^{2} &amp; 0 &amp; \cdots &amp; 0\\
0 &amp; \sigma_{u}^{2} &amp; \cdots &amp; 0\\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots\\
0 &amp; 0 &amp; \cdots &amp; \sigma_{u}^{2}
\end{array}\right)
\end{split}\]</div>
<p>where the first half of the first column of <span class="math notranslate nohighlight">\(\Lambda\)</span> is filled
with <span class="math notranslate nohighlight">\(1\)</span>s and <span class="math notranslate nohighlight">\(0\)</span>s for the rest half, and symmetrically
for the second column. <span class="math notranslate nohighlight">\(D\)</span> is a diagonal matrix with parameter
<span class="math notranslate nohighlight">\(\sigma_{u}^{2}\)</span> on the diagonal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Λ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<span class="n">Λ</span><span class="p">[:</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Λ</span><span class="p">[</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">σu</span> <span class="o">=</span> <span class="mf">.5</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">σu</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute Σy</span>
<span class="n">Σy</span> <span class="o">=</span> <span class="n">Λ</span> <span class="o">@</span> <span class="n">Λ</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">D</span>
</pre></div>
</div>
</div>
</div>
<p>We can now construct the mean vector and the covariance matrix for
<span class="math notranslate nohighlight">\(Z\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="p">)</span>

<span class="n">Σz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="p">))</span>

<span class="n">Σz</span><span class="p">[:</span><span class="n">k</span><span class="p">,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">Σz</span><span class="p">[:</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Λ</span><span class="o">.</span><span class="n">T</span>
<span class="n">Σz</span><span class="p">[</span><span class="n">k</span><span class="p">:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Λ</span>
<span class="n">Σz</span><span class="p">[</span><span class="n">k</span><span class="p">:,</span> <span class="n">k</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Σy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μz</span><span class="p">,</span> <span class="n">Σz</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_factor</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μz</span><span class="p">,</span> <span class="n">Σz</span><span class="p">)</span>
<span class="n">multi_normal_factor</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s compute the conditional distribution of the hidden factor
<span class="math notranslate nohighlight">\(f\)</span> on the observations <span class="math notranslate nohighlight">\(Y\)</span>, namely, <span class="math notranslate nohighlight">\(f \mid Y=y\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_factor</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-0.49493974, -0.50243879]),
 array([[0.04761905, 0.        ],
        [0.        , 0.04761905]]))
</pre></div>
</div>
</div>
</div>
<p>We can verify that the conditional mean
<span class="math notranslate nohighlight">\(E \left[f \mid Y=y\right] = B Y\)</span> where
<span class="math notranslate nohighlight">\(B = \Lambda^{\prime} \Sigma_{y}^{-1}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B</span> <span class="o">=</span> <span class="n">Λ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Σy</span><span class="p">)</span>

<span class="n">B</span> <span class="o">@</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.49493974, -0.50243879])
</pre></div>
</div>
</div>
</div>
<p>Similarly, we can compute the conditional distribution <span class="math notranslate nohighlight">\(Y \mid f\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal_factor</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-0.24088341, -0.24088341, -0.24088341, -0.24088341, -0.24088341,
        -0.46545348, -0.46545348, -0.46545348, -0.46545348, -0.46545348]),
 array([[0.25, 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
        [0.  , 0.25, 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
        [0.  , 0.  , 0.25, 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
        [0.  , 0.  , 0.  , 0.25, 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
        [0.  , 0.  , 0.  , 0.  , 0.25, 0.  , 0.  , 0.  , 0.  , 0.  ],
        [0.  , 0.  , 0.  , 0.  , 0.  , 0.25, 0.  , 0.  , 0.  , 0.  ],
        [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.25, 0.  , 0.  , 0.  ],
        [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.25, 0.  , 0.  ],
        [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.25, 0.  ],
        [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.25]]))
</pre></div>
</div>
</div>
</div>
<p>It can be verified that the mean is
<span class="math notranslate nohighlight">\(\Lambda I^{-1} f = \Lambda f\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Λ</span> <span class="o">@</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.24088341, -0.24088341, -0.24088341, -0.24088341, -0.24088341,
       -0.46545348, -0.46545348, -0.46545348, -0.46545348, -0.46545348])
</pre></div>
</div>
</div>
</div>
</section>
<section id="pca-as-approximation-to-factor-analytic-model">
<h2><a class="toc-backref" href="#id12"><span class="section-number">12.11. </span>PCA as Approximation to Factor Analytic Model</a><a class="headerlink" href="#pca-as-approximation-to-factor-analytic-model" title="Permalink to this headline">¶</a></h2>
<p>For fun, let’s apply a Principal Components Analysis (PCA) decomposition
to a covariance matrix <span class="math notranslate nohighlight">\(\Sigma_y\)</span> that in fact is governed by our factor-analytic
model.</p>
<p>Technically, this means that the PCA model is misspecified. (Can you
explain why?)</p>
<p>Nevertheless, this exercise will let us study how well the first two
principal components from a PCA can approximate the conditional
expectations <span class="math notranslate nohighlight">\(E f_i | Y\)</span> for our two factors <span class="math notranslate nohighlight">\(f_i\)</span>,
<span class="math notranslate nohighlight">\(i=1,2\)</span> for the factor analytic model that we have assumed truly
governs the data on <span class="math notranslate nohighlight">\(Y\)</span> we have generated.</p>
<p>So we compute the PCA decomposition</p>
<div class="math notranslate nohighlight">
\[
\Sigma_{y} = P \tilde{\Lambda} P^{\prime}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\tilde{\Lambda}\)</span> is a diagonal matrix.</p>
<p>We have</p>
<div class="math notranslate nohighlight">
\[
Y = P \epsilon
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\epsilon = P^\prime Y
\]</div>
<p>Note that we will arrange the eigenvectors in <span class="math notranslate nohighlight">\(P\)</span> in the
<em>descending</em> order of eigenvalues.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">𝜆_tilde</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Σy</span><span class="p">)</span>

<span class="c1"># arrange the eigenvectors by eigenvalues</span>
<span class="n">ind</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">𝜆_tilde</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
<span class="n">𝜆_tilde</span> <span class="o">=</span> <span class="n">𝜆_tilde</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
<span class="n">Λ_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">𝜆_tilde</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;𝜆_tilde =&#39;</span><span class="p">,</span> <span class="n">𝜆_tilde</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>𝜆_tilde = [5.25 5.25 0.25 0.25 0.25 0.25 0.25 0.25 0.25 0.25]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># verify the orthogonality of eigenvectors</span>
<span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">P</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.440892098500626e-16
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># verify the eigenvalue decomposition is correct</span>
<span class="n">P</span> <span class="o">@</span> <span class="n">Λ_tilde</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.25, 1.  , 1.  , 1.  , 1.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
       [1.  , 1.25, 1.  , 1.  , 1.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
       [1.  , 1.  , 1.25, 1.  , 1.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
       [1.  , 1.  , 1.  , 1.25, 1.  , 0.  , 0.  , 0.  , 0.  , 0.  ],
       [1.  , 1.  , 1.  , 1.  , 1.25, 0.  , 0.  , 0.  , 0.  , 0.  ],
       [0.  , 0.  , 0.  , 0.  , 0.  , 1.25, 1.  , 1.  , 1.  , 1.  ],
       [0.  , 0.  , 0.  , 0.  , 0.  , 1.  , 1.25, 1.  , 1.  , 1.  ],
       [0.  , 0.  , 0.  , 0.  , 0.  , 1.  , 1.  , 1.25, 1.  , 1.  ],
       [0.  , 0.  , 0.  , 0.  , 0.  , 1.  , 1.  , 1.  , 1.25, 1.  ],
       [0.  , 0.  , 0.  , 0.  , 0.  , 1.  , 1.  , 1.  , 1.  , 1.25]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ε</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ε = &quot;</span><span class="p">,</span> <span class="n">ε</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ε =  [-1.16205486 -1.17966165 -0.65586587  1.21758892  0.51674721  0.42983901
 -0.72496672  0.83223988 -0.00852009  0.50958057]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print the values of the two factors</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;f = &#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f =  [-0.24088341 -0.46545348]
</pre></div>
</div>
</div>
</div>
<p>Below we’ll plot several things</p>
<ul class="simple">
<li><p>the <span class="math notranslate nohighlight">\(N\)</span> values of <span class="math notranslate nohighlight">\(y\)</span></p></li>
<li><p>the <span class="math notranslate nohighlight">\(N\)</span> values of the principal components <span class="math notranslate nohighlight">\(\epsilon\)</span></p></li>
<li><p>the value of the first factor <span class="math notranslate nohighlight">\(f_1\)</span> plotted only for the first
<span class="math notranslate nohighlight">\(N/2\)</span> observations of <span class="math notranslate nohighlight">\(y\)</span> for which it receives a
non-zero loading in <span class="math notranslate nohighlight">\(\Lambda\)</span></p></li>
<li><p>the value of the second factor <span class="math notranslate nohighlight">\(f_2\)</span> plotted only for the final
<span class="math notranslate nohighlight">\(N/2\)</span> observations for which it receives a non-zero loading in
<span class="math notranslate nohighlight">\(\Lambda\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">ε</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\epsilon$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f_</span><span class="si">{1}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f_</span><span class="si">{2}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/multivariate_normal_117_0.png" src="_images/multivariate_normal_117_0.png" />
</div>
</div>
<p>Consequently, the first two <span class="math notranslate nohighlight">\(\epsilon_{j}\)</span> correspond to the
largest two eigenvalues.</p>
<p>Let’s look at them, after which we’ll look at <span class="math notranslate nohighlight">\(E f | y = B y\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ε</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-1.16205486, -1.17966165])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compare with Ef|y</span>
<span class="n">B</span> <span class="o">@</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.49493974, -0.50243879])
</pre></div>
</div>
</div>
</div>
<p>The fraction of variance in <span class="math notranslate nohighlight">\(y_{t}\)</span> explained by the first two
principal components can be computed as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">𝜆_tilde</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">𝜆_tilde</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.84
</pre></div>
</div>
</div>
</div>
<p>Compute</p>
<div class="math notranslate nohighlight">
\[
\hat{Y} = P_{j} \epsilon_{j} + P_{k} \epsilon_{k}
\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{j}\)</span> and <span class="math notranslate nohighlight">\(P_{k}\)</span> correspond to the largest two
eigenvalues.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_hat</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">ε</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>In this example, it turns out that the projection <span class="math notranslate nohighlight">\(\hat{Y}\)</span> of
<span class="math notranslate nohighlight">\(Y\)</span> on the first two principal components does a good job of
approximating <span class="math notranslate nohighlight">\(Ef \mid y\)</span>.</p>
<p>We confirm this in the following plot of <span class="math notranslate nohighlight">\(f\)</span>,
<span class="math notranslate nohighlight">\(E y \mid f\)</span>, <span class="math notranslate nohighlight">\(E f \mid y\)</span>, and <span class="math notranslate nohighlight">\(\hat{y}\)</span> on the
coordinate axis versus <span class="math notranslate nohighlight">\(y\)</span> on the ordinate axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">Λ</span> <span class="o">@</span> <span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$Ey|f$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\hat</span><span class="si">{y}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f_</span><span class="si">{1}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f_</span><span class="si">{2}</span><span class="s1">$&#39;</span><span class="p">)</span>

<span class="n">Efy</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">y</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">Efy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$Ef_</span><span class="si">{1}</span><span class="s1">|y$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">Efy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$Ef_</span><span class="si">{2}</span><span class="s1">|y$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/multivariate_normal_126_0.png" src="_images/multivariate_normal_126_0.png" />
</div>
</div>
<p>The covariance matrix of <span class="math notranslate nohighlight">\(\hat{Y}\)</span> can be computed by first
constructing the covariance matrix of <span class="math notranslate nohighlight">\(\epsilon\)</span> and then use the
upper left block for <span class="math notranslate nohighlight">\(\epsilon_{1}\)</span> and <span class="math notranslate nohighlight">\(\epsilon_{2}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Σεjk</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Σy</span> <span class="o">@</span> <span class="n">P</span><span class="p">)[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

<span class="n">Pjk</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

<span class="n">Σy_hat</span> <span class="o">=</span> <span class="n">Pjk</span> <span class="o">@</span> <span class="n">Σεjk</span> <span class="o">@</span> <span class="n">Pjk</span><span class="o">.</span><span class="n">T</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Σy_hat = </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Σy_hat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Σy_hat = 
 [[1.05 1.05 1.05 1.05 1.05 0.   0.   0.   0.   0.  ]
 [1.05 1.05 1.05 1.05 1.05 0.   0.   0.   0.   0.  ]
 [1.05 1.05 1.05 1.05 1.05 0.   0.   0.   0.   0.  ]
 [1.05 1.05 1.05 1.05 1.05 0.   0.   0.   0.   0.  ]
 [1.05 1.05 1.05 1.05 1.05 0.   0.   0.   0.   0.  ]
 [0.   0.   0.   0.   0.   1.05 1.05 1.05 1.05 1.05]
 [0.   0.   0.   0.   0.   1.05 1.05 1.05 1.05 1.05]
 [0.   0.   0.   0.   0.   1.05 1.05 1.05 1.05 1.05]
 [0.   0.   0.   0.   0.   1.05 1.05 1.05 1.05 1.05]
 [0.   0.   0.   0.   0.   1.05 1.05 1.05 1.05 1.05]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="stochastic-difference-equation">
<h2><a class="toc-backref" href="#id13"><span class="section-number">12.12. </span>Stochastic Difference Equation</a><a class="headerlink" href="#stochastic-difference-equation" title="Permalink to this headline">¶</a></h2>
<p>Consider the stochastic second-order linear difference equation</p>
<div class="math notranslate nohighlight">
\[
y_{t} = \alpha_{0} + \alpha_{1} y_{y-1} + \alpha_{2} y_{t-2} + u_{t}
\]</div>
<p>where <span class="math notranslate nohighlight">\(u_{t} \sim N \left(0, \sigma_{u}^{2}\right)\)</span> and</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\left[\begin{array}{c}
y_{-1}\\
y_{0}
\end{array}\right]\sim N\left(\mu_{\tilde{y}},\Sigma_{\tilde{y}}\right)
\end{split}\]</div>
<p>It can be written as a stacked system</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\underset{\equiv A}{\underbrace{\left[\begin{array}{cccccccc}
1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 &amp; 0\\
-\alpha_{1} &amp; 1 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 &amp; 0\\
-\alpha_{2} &amp; -\alpha_{1} &amp; 1 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 &amp; 0\\
0 &amp; -\alpha_{2} &amp; -\alpha_{1} &amp; 1 &amp; \cdots &amp; 0 &amp; 0 &amp; 0\\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \cdots &amp; \vdots &amp; \vdots &amp; \vdots\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; -\alpha_{2} &amp; -\alpha_{1} &amp; 1
\end{array}\right]}}\left[\begin{array}{c}
y_{1}\\
y_{2}\\
y_{3}\\
y_{4}\\
\vdots\\
y_{T}
\end{array}\right]=\underset{\equiv b}{\underbrace{\left[\begin{array}{c}
\alpha_{0}+\alpha_{1}y_{0}+\alpha_{2}y_{-1}\\
\alpha_{0}+\alpha_{2}y_{0}\\
\alpha_{0}\\
\alpha_{0}\\
\vdots\\
\alpha_{0}
\end{array}\right]}}
\end{split}\]</div>
<p>We can compute <span class="math notranslate nohighlight">\(y\)</span> by solving the system</p>
<div class="math notranslate nohighlight">
\[
y = A^{-1} \left(b + u\right)
\]</div>
<p>We have</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\mu_{y} = A^{-1} \mu_{b} \\
\Sigma_{y} &amp;= A^{-1} E \left[\left(b - \mu_{b} + u \right) \left(b - \mu_{b} + u \right)^{\prime}\right] \left(A^{-1}\right)^{\prime} \\
           &amp;= A^{-1} \left(\Sigma_{b} + \Sigma_{u} \right) \left(A^{-1}\right)^{\prime}
\end{aligned}
\end{split}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mu_{b}=\left[\begin{array}{c}
\alpha_{0}+\alpha_{1}\mu_{y_{0}}+\alpha_{2}\mu_{y_{-1}}\\
\alpha_{0}+\alpha_{2}\mu_{y_{0}}\\
\alpha_{0}\\
\vdots\\
\alpha_{0}
\end{array}\right]
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
\Sigma_{b}=\left[\begin{array}{cc}
C\Sigma_{\tilde{y}}C^{\prime} &amp; \boldsymbol{0}_{N-2\times N-2}\\
\boldsymbol{0}_{N-2\times2} &amp; \boldsymbol{0}_{N-2\times N-2}
\end{array}\right],\quad C=\left[\begin{array}{cc}
\alpha_{2} &amp; \alpha_{1}\\
0 &amp; \alpha_{2}
\end{array}\right]
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
\Sigma_{u}=\left[\begin{array}{cccc}
\sigma_{u}^{2} &amp; 0 &amp; \cdots &amp; 0\\
0 &amp; \sigma_{u}^{2} &amp; \cdots &amp; 0\\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots\\
0 &amp; 0 &amp; \cdots &amp; \sigma_{u}^{2}
\end{array}\right]
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set parameters</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">160</span>
<span class="c1"># coefficients of the second order difference equation</span>
<span class="n">𝛼0</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">𝛼1</span> <span class="o">=</span> <span class="mf">1.53</span>
<span class="n">𝛼2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.9</span>

<span class="c1"># variance of u</span>
<span class="n">σu</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">σu</span> <span class="o">=</span> <span class="mf">10.</span>

<span class="c1"># distribution of y_{-1} and y_{0}</span>
<span class="n">μy_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">Σy_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct A and A^{\prime}</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">𝛼1</span>

    <span class="k">if</span> <span class="n">i</span><span class="o">-</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">𝛼2</span>

<span class="n">A_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the mean vectors of b and y</span>
<span class="n">μb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">𝛼0</span><span class="p">)</span>
<span class="n">μb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">𝛼1</span> <span class="o">*</span> <span class="n">μy_tilde</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">𝛼2</span> <span class="o">*</span> <span class="n">μy_tilde</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">μb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">𝛼2</span> <span class="o">*</span> <span class="n">μy_tilde</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">μy</span> <span class="o">=</span> <span class="n">A_inv</span> <span class="o">@</span> <span class="n">μb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the covariance matrices of b and y</span>
<span class="n">Σu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">σu</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">Σb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">𝛼2</span><span class="p">,</span> <span class="n">𝛼1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">𝛼2</span><span class="p">]])</span>
<span class="n">Σb</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">Σy_tilde</span> <span class="o">@</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span>

<span class="n">Σy</span> <span class="o">=</span> <span class="n">A_inv</span> <span class="o">@</span> <span class="p">(</span><span class="n">Σb</span> <span class="o">+</span> <span class="n">Σu</span><span class="p">)</span> <span class="o">@</span> <span class="n">A_inv</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="application-to-stock-price-model">
<h2><a class="toc-backref" href="#id14"><span class="section-number">12.13. </span>Application to Stock Price Model</a><a class="headerlink" href="#application-to-stock-price-model" title="Permalink to this headline">¶</a></h2>
<p>Let</p>
<div class="math notranslate nohighlight">
\[
p_{t} = \sum_{j=0}^{T-t} \beta^{j} y_{t+j}
\]</div>
<p>Form</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\underset{\equiv p}{\underbrace{\left[\begin{array}{c}
p_{1}\\
p_{2}\\
p_{3}\\
\vdots\\
p_{T}
\end{array}\right]}}=\underset{\equiv B}{\underbrace{\left[\begin{array}{ccccc}
1 &amp; \beta &amp; \beta^{2} &amp; \cdots &amp; \beta^{T-1}\\
0 &amp; 1 &amp; \beta &amp; \cdots &amp; \beta^{T-2}\\
0 &amp; 0 &amp; 1 &amp; \cdots &amp; \beta^{T-3}\\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots\\
0 &amp; 0 &amp; 0 &amp; \cdots &amp; 1
\end{array}\right]}}\left[\begin{array}{c}
y_{1}\\
y_{2}\\
y_{3}\\
\vdots\\
y_{T}
\end{array}\right]
\end{split}\]</div>
<p>we have</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\mu_{p} = B \mu_{y} \\
\Sigma_{p} = B \Sigma_{y} B^{\prime}
\end{aligned}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">β</span> <span class="o">=</span> <span class="mf">.96</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct B</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">β</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Denote</p>
<div class="math notranslate nohighlight">
\[\begin{split}
z=\left[\begin{array}{c}
y\\
p
\end{array}\right]=\underset{\equiv D}{\underbrace{\left[\begin{array}{c}
I\\
B
\end{array}\right]}} y
\end{split}\]</div>
<p>Thus, <span class="math notranslate nohighlight">\(\{y_t\}_{t=1}^{T}\)</span> and <span class="math notranslate nohighlight">\(\{p_t\}_{t=1}^{T}\)</span> jointly
follow the multivariate normal distribution
<span class="math notranslate nohighlight">\(N \left(\mu_{z}, \Sigma_{z}\right)\)</span>, where</p>
<div class="math notranslate nohighlight">
\[
\mu_{z}=D\mu_{y}
\]</div>
<div class="math notranslate nohighlight">
\[
\Sigma_{z}=D\Sigma_{y}D^{\prime}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">B</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μz</span> <span class="o">=</span> <span class="n">D</span> <span class="o">@</span> <span class="n">μy</span>
<span class="n">Σz</span> <span class="o">=</span> <span class="n">D</span> <span class="o">@</span> <span class="n">Σy</span> <span class="o">@</span> <span class="n">D</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<p>We can simulate paths of <span class="math notranslate nohighlight">\(y_{t}\)</span> and <span class="math notranslate nohighlight">\(p_{t}\)</span> and compute the
conditional mean <span class="math notranslate nohighlight">\(E \left[p_{t} \mid y_{t-1}, y_{t}\right]\)</span> using
the <code class="docutils literal notranslate"><span class="pre">MultivariateNormal</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">μz</span><span class="p">,</span> <span class="n">Σz</span><span class="p">)</span>
<span class="n">y</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">T</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">T</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cond_Ep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">sub_μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">sub_Σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">sub_μ</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">μz</span><span class="p">[[</span><span class="n">t</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">t</span><span class="p">]]</span>
    <span class="n">sub_Σ</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Σz</span><span class="p">[[</span><span class="n">t</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">t</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">t</span><span class="p">]]</span>

    <span class="n">multi_normal</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">sub_μ</span><span class="p">,</span> <span class="n">sub_Σ</span><span class="p">)</span>
    <span class="n">multi_normal</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">cond_Ep</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">t</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$y_</span><span class="si">{t}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$y_{t-1}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$p_</span><span class="si">{t}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">cond_Ep</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$Ep_</span><span class="si">{t}</span><span class="s1">|y_</span><span class="si">{t}</span><span class="s1">, y_{t-1}$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/multivariate_normal_143_0.png" src="_images/multivariate_normal_143_0.png" />
</div>
</div>
<p>In the above graph, the green line is what the price of the stock would
be if people had perfect foresight about the path of dividends while the
green line is the conditional expectation <span class="math notranslate nohighlight">\(E p_t | y_t, y_{t-1}\)</span>, which is what the price would
be if people did not have perfect foresight but were optimally
predicting future dividends on the basis of the information
<span class="math notranslate nohighlight">\(y_t, y_{t-1}\)</span> at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
</section>
<section id="filtering-foundations">
<h2><a class="toc-backref" href="#id15"><span class="section-number">12.14. </span>Filtering Foundations</a><a class="headerlink" href="#filtering-foundations" title="Permalink to this headline">¶</a></h2>
<p>Assume that <span class="math notranslate nohighlight">\(x_0\)</span> is an <span class="math notranslate nohighlight">\(n \times 1\)</span> random vector and that
<span class="math notranslate nohighlight">\(y_0\)</span> is a <span class="math notranslate nohighlight">\(p \times 1\)</span> random vector determined by the
<em>observation equation</em></p>
<div class="math notranslate nohighlight">
\[
y_0 = G x_0 + v_0  , \quad x_0 \sim {\mathcal N}(\hat x_0, \Sigma_0), \quad v_0 \sim {\mathcal N}(0, R)
\]</div>
<p>where <span class="math notranslate nohighlight">\(v_0\)</span> is orthogonal to <span class="math notranslate nohighlight">\(x_0\)</span>, <span class="math notranslate nohighlight">\(G\)</span> is a
<span class="math notranslate nohighlight">\(p \times n\)</span> matrix, and <span class="math notranslate nohighlight">\(R\)</span> is a <span class="math notranslate nohighlight">\(p \times p\)</span>
positive definite matrix.</p>
<p>We consider the problem of someone who <em>observes</em> <span class="math notranslate nohighlight">\(y_0\)</span>, who does
not observe <span class="math notranslate nohighlight">\(x_0\)</span>, who knows <span class="math notranslate nohighlight">\(\hat x_0, \Sigma_0, G, R\)</span> –
and therefore knows the joint probability distribution of the vector
<span class="math notranslate nohighlight">\(\begin{bmatrix} x_0 \cr y_0 \end{bmatrix}\)</span> – and who wants to
infer <span class="math notranslate nohighlight">\(x_0\)</span> from <span class="math notranslate nohighlight">\(y_0\)</span> in light of what he knows about that
joint probability distribution.</p>
<p>Therefore, the person wants to construct the probability distribution of
<span class="math notranslate nohighlight">\(x_0\)</span> conditional on the random vector <span class="math notranslate nohighlight">\(y_0\)</span>.</p>
<p>The joint distribution of
<span class="math notranslate nohighlight">\(\begin{bmatrix} x_0 \cr y_0 \end{bmatrix}\)</span> is multivariate normal
<span class="math notranslate nohighlight">\({\mathcal N}(\mu, \Sigma)\)</span> with</p>
<div class="math notranslate nohighlight">
\[
\mu = \begin{bmatrix} \hat x_0 \cr G \hat x_0 \end{bmatrix} , \quad
  \Sigma = \begin{bmatrix} \Sigma_0 &amp; \Sigma_0 G' \cr
                          G \Sigma_0 &amp; G \Sigma_0 G' + R \end{bmatrix}
\]</div>
<p>By applying an appropriate instance of the above formulas for the  mean vector <span class="math notranslate nohighlight">\(\hat \mu_1\)</span> and covariance matrix
<span class="math notranslate nohighlight">\(\hat \Sigma_{11}\)</span> of <span class="math notranslate nohighlight">\(z_1\)</span> conditional on <span class="math notranslate nohighlight">\(z_2\)</span>, we find that the probability distribution of
<span class="math notranslate nohighlight">\(x_0\)</span> conditional on <span class="math notranslate nohighlight">\(y_0\)</span> is
<span class="math notranslate nohighlight">\({\mathcal N}(\tilde x_0, \tilde \Sigma_0)\)</span> where</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned} \beta_0  &amp; = \Sigma_0 G' (G \Sigma_0 G' + R)^{-1} \cr
\tilde x_0 &amp; = \hat x_0 + \beta_0 ( y_0 - G \hat x_0) \cr
 \tilde \Sigma_0 &amp; = \Sigma_0 - \Sigma_0 G' (G \Sigma_0 G' + R)^{-1} G \Sigma_0
  \end{aligned}
\]</div>
<section id="step-toward-dynamics">
<h3><span class="section-number">12.14.1. </span>Step toward dynamics<a class="headerlink" href="#step-toward-dynamics" title="Permalink to this headline">¶</a></h3>
<p>Now suppose that we are in a time series setting and that we have the
one-step state transition equation</p>
<div class="math notranslate nohighlight">
\[
x_1 = A x_0 + C w_1 ,  \quad w_1 \sim {\mathcal N}(0, I )
\]</div>
<p>where <span class="math notranslate nohighlight">\(A\)</span> is an <span class="math notranslate nohighlight">\(n \times n\)</span> matrix and <span class="math notranslate nohighlight">\(C\)</span> is an
<span class="math notranslate nohighlight">\(n \times m\)</span> matrix.</p>
<p>It follows that the probability distribution of <span class="math notranslate nohighlight">\(x_1\)</span> conditional
on <span class="math notranslate nohighlight">\(y_0\)</span> is</p>
<div class="math notranslate nohighlight">
\[
x_1 | y_0 \sim {\mathcal N}(A \tilde x_0 , A \tilde \Sigma_0 A' + C C' )
\]</div>
<p>Define</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned} \hat x_1 &amp; = A \tilde x_0 \cr
               \Sigma_1 &amp; = A \tilde \Sigma_0 A' + C C'
\end{aligned}
\]</div>
</section>
<section id="dynamic-version">
<h3><span class="section-number">12.14.2. </span>Dynamic version<a class="headerlink" href="#dynamic-version" title="Permalink to this headline">¶</a></h3>
<p>Suppose now that for <span class="math notranslate nohighlight">\(t \geq 0\)</span>,
<span class="math notranslate nohighlight">\(\{x_{t+1}, y_t\}_{t=0}^\infty\)</span> are governed by the equations</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned}
x_{t+1} &amp; = A x_t + C w_{t+1} \cr
y_t &amp; = G x_t + v_t
\end{aligned}
\]</div>
<p>where as before <span class="math notranslate nohighlight">\(x_0 \sim {\mathcal N}(\hat x_0, \Sigma_0)\)</span>,
<span class="math notranslate nohighlight">\(w_{t+1}\)</span> is the <span class="math notranslate nohighlight">\(t+1\)</span>th component of an i.i.d. stochastic
process distributed as <span class="math notranslate nohighlight">\(w_{t+1} \sim {\mathcal N}(0, I)\)</span>, and
<span class="math notranslate nohighlight">\(v_t\)</span> is the <span class="math notranslate nohighlight">\(t\)</span>th component of an i.i.d. process
distributed as <span class="math notranslate nohighlight">\(v_t \sim {\mathcal N}(0, R)\)</span> and the
<span class="math notranslate nohighlight">\(\{w_{t+1}\}_{t=0}^\infty\)</span> and <span class="math notranslate nohighlight">\(\{v_t\}_{t=0}^\infty\)</span>
processes are orthogonal at all pairs of dates.</p>
<p>The logic and
formulas that we applied above imply that the probability distribution
of <span class="math notranslate nohighlight">\(x_t\)</span> conditional on
<span class="math notranslate nohighlight">\(y_0, y_1, \ldots , y_{t-1} = y^{t-1}\)</span> is</p>
<div class="math notranslate nohighlight">
\[
x_t | y^{t-1} \sim {\mathcal N}(A \tilde x_t , A \tilde \Sigma_t A' + C C' )
\]</div>
<p>where <span class="math notranslate nohighlight">\(\{\tilde x_t, \tilde \Sigma_t\}_{t=1}^\infty\)</span> can be
computed by iterating on the following equations starting from
<span class="math notranslate nohighlight">\(t=1\)</span> and initial conditions for
<span class="math notranslate nohighlight">\(\tilde x_0, \tilde \Sigma_0\)</span> computed as we have above:</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned} \Sigma_t &amp; = A  \tilde \Sigma_{t-1} A' + C C' \cr
               \hat x_t &amp; = A \tilde x_{t-1} \cr
\beta_t &amp; = \Sigma_t G' (G \Sigma_t G' + R)^{-1} \cr
\tilde x_t &amp; = \hat x_t + \beta_t ( y_t - G \hat x_t) \cr
 \tilde \Sigma_t &amp; = \Sigma_t - \Sigma_t G' (G \Sigma_t G' + R)^{-1} G \Sigma_t
  \end{aligned}
\]</div>
<p>We can use the Python class <em>MultivariateNormal</em> to construct examples.</p>
<p>Here is an example for a single period problem at time <span class="math notranslate nohighlight">\(0\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]])</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">]])</span>

<span class="n">x0_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
<span class="n">Σ0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">.3</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]])</span>

<span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x0_hat</span><span class="p">,</span> <span class="n">G</span> <span class="o">@</span> <span class="n">x0_hat</span><span class="p">])</span>
<span class="n">Σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Σ0</span><span class="p">,</span> <span class="n">Σ0</span> <span class="o">@</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="p">[</span><span class="n">G</span> <span class="o">@</span> <span class="n">Σ0</span><span class="p">,</span> <span class="n">G</span> <span class="o">@</span> <span class="n">Σ0</span> <span class="o">@</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construction of the multivariate normal instance</span>
<span class="n">multi_normal</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_normal</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the observation of y</span>
<span class="n">y0</span> <span class="o">=</span> <span class="mf">2.3</span>

<span class="c1"># conditional distribution of x0</span>
<span class="n">μ1_hat</span><span class="p">,</span> <span class="n">Σ11</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
<span class="n">μ1_hat</span><span class="p">,</span> <span class="n">Σ11</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-0.078125,  0.803125]),
 array([[ 0.72098214, -0.203125  ],
        [-0.403125  ,  0.228125  ]]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]])</span>

<span class="c1"># conditional distribution of x1</span>
<span class="n">x1_cond</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">μ1_hat</span>
<span class="n">Σ1_cond</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">A</span> <span class="o">@</span> <span class="n">Σ11</span> <span class="o">@</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>
<span class="n">x1_cond</span><span class="p">,</span> <span class="n">Σ1_cond</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.1215625, 0.24875  ]),
 array([[4.12874554, 1.95523214],
        [1.92123214, 1.04592857]]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="code-for-iterating">
<h3><span class="section-number">12.14.3. </span>Code for Iterating<a class="headerlink" href="#code-for-iterating" title="Permalink to this headline">¶</a></h3>
<p>Here is code for solving a dynamic filtering problem by iterating on our
equations, followed by an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">x0_hat</span><span class="p">,</span> <span class="n">Σ0</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">y_seq</span><span class="p">):</span>

    <span class="n">p</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_seq</span><span class="p">)</span>
    <span class="n">x_hat_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">Σ_hat_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="n">x_hat_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0_hat</span>
    <span class="n">Σ_hat_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Σ0</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">xt_hat</span> <span class="o">=</span> <span class="n">x_hat_seq</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">Σt</span> <span class="o">=</span> <span class="n">Σ_hat_seq</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">xt_hat</span><span class="p">,</span> <span class="n">G</span> <span class="o">@</span> <span class="n">xt_hat</span><span class="p">])</span>
        <span class="n">Σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Σt</span><span class="p">,</span> <span class="n">Σt</span> <span class="o">@</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="p">[</span><span class="n">G</span> <span class="o">@</span> <span class="n">Σt</span><span class="p">,</span> <span class="n">G</span> <span class="o">@</span> <span class="n">Σt</span> <span class="o">@</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span><span class="p">]])</span>

        <span class="c1"># filtering</span>
        <span class="n">multi_normal</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">Σ</span><span class="p">)</span>
        <span class="n">multi_normal</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">x_tilde</span><span class="p">,</span> <span class="n">Σ_tilde</span> <span class="o">=</span> <span class="n">multi_normal</span><span class="o">.</span><span class="n">cond_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_seq</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

        <span class="c1"># forecasting</span>
        <span class="n">x_hat_seq</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">x_tilde</span>
        <span class="n">Σ_hat_seq</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">A</span> <span class="o">@</span> <span class="n">Σ_tilde</span> <span class="o">@</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">x_hat_seq</span><span class="p">,</span> <span class="n">Σ_hat_seq</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iterate</span><span class="p">(</span><span class="n">x0_hat</span><span class="p">,</span> <span class="n">Σ0</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.        , 1.        ],
        [0.1215625 , 0.24875   ],
        [0.18680212, 0.06904689],
        [0.75576875, 0.05558463]]),
 array([[[1.        , 0.5       ],
         [0.3       , 2.        ]],
 
        [[4.12874554, 1.95523214],
         [1.92123214, 1.04592857]],
 
        [[4.08198663, 1.99218488],
         [1.98640488, 1.00886423]],
 
        [[4.06457628, 2.00041999],
         [1.99943739, 1.00275526]]]))
</pre></div>
</div>
</div>
</div>
<p>The iterative algorithm just described is a version of the celebrated <strong>Kalman filter</strong>.</p>
<p>We describe the Kalman filter  and some applications of it in <a class="reference internal" href="kalman.html"><span class="doc">A First Look at the Kalman Filter</span></a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="geom_series.html">
   1. Geometric Series for Elementary Economics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multi_hyper.html">
   2. Multivariate Hypergeometric Distribution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sir_model.html">
   3. Modeling COVID 19
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linear_algebra.html">
   4. Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="qr_decomp.html">
   5. QR Decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="svd_intro.html">
   6. Singular Value Decomposition (SVD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="complex_and_trig.html">
   7. Complex Numbers and Trigonometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="eig_circulant.html">
   8. Circulant Matrices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lln_clt.html">
   9. LLN and CLT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="prob_meaning.html">
   10. Two Meanings of Probability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="heavy_tails.html">
   11. Heavy-Tailed Distributions
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   12. Multivariate Normal Distribution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hoist_failure.html">
   13. Fault Tree Uncertainties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="time_series_with_matrices.html">
   14. Univariate Time Series with Matrix Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="back_prop.html">
   15. Introduction to Artificial Neural Networks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Linear Programming
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lp_intro.html">
   16. Linear Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="opt_transport.html">
   17. Optimal Transport
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="von_neumann_model.html">
   18. Von Neumann Growth Model (and a Generalization)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Dynamics
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="scalar_dynam.html">
   19. Dynamics in One Dimension
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ar1_processes.html">
   20. AR1 Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="finite_markov.html">
   21. Finite Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="inventory_dynamics.html">
   22. Inventory Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linear_models.html">
   23. Linear State Space Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="samuelson.html">
   24. Application: The Samuelson Multiplier-Accelerator
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kesten_processes.html">
   25. Kesten Processes and Firm Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wealth_dynamics.html">
   26. Wealth Distribution Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kalman.html">
   27. A First Look at the Kalman Filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="short_path.html">
   28. Shortest Paths
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cass_koopmans_1.html">
   29. Cass-Koopmans Planning Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cass_koopmans_2.html">
   30. Cass-Koopmans Competitive Equilibrium
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Search
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_model.html">
   31. Job Search I: The McCall Search Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_model_with_separation.html">
   32. Job Search II: Search and Separation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_fitted_vfi.html">
   33. Job Search III: Fitted Value Function Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mccall_correlated.html">
   34. Job Search IV: Correlated Wage Offers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="career.html">
   35. Job Search V: Modeling Career Choice
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="jv.html">
   36. Job Search VI: On-the-Job Search
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Consumption, Savings and Growth
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_problem.html">
   37. Cake Eating I: Introduction to Optimal Saving
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cake_eating_numerical.html">
   38. Cake Eating II: Numerical Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="optgrowth.html">
   39. Optimal Growth I: The Stochastic Optimal Growth Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="optgrowth_fast.html">
   40. Optimal Growth II: Accelerating the Code with Numba
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coleman_policy_iter.html">
   41. Optimal Growth III: Time Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="egm_policy_iter.html">
   42. Optimal Growth IV: The Endogenous Grid Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ifp.html">
   43. The Income Fluctuation Problem I: Basic Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ifp_advanced.html">
   44. The Income Fluctuation Problem II: Stochastic Returns on Assets
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Information
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="odu.html">
   45. Job Search VII: Search with Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="likelihood_ratio_process.html">
   46. Likelihood Ratio Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="imp_sample.html">
   47. Computing Mean of a Likelihood Ratio Process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wald_friedman.html">
   48. A Problem that Stumped Milton Friedman
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="exchangeable.html">
   49. Exchangeability and Bayesian Updating
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="likelihood_bayes.html">
   50. Likelihood Ratio Processes and Bayesian Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="navy_captain.html">
   51. Bayesian versus Frequentist Decision Rules
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  LQ Control
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lqcontrol.html">
   52. LQ Control: Foundations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lagrangian_lqdp.html">
   53. Lagrangian for LQ Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cross_product_trick.html">
   54. Eliminating Cross Products
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="perm_income.html">
   55. The Permanent Income Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="perm_income_cons.html">
   56. Permanent Income II: LQ Techniques
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lq_inventories.html">
   57. Production Smoothing via Inventories
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="schelling.html">
   58. Schelling’s Segregation Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lake_model.html">
   59. A Lake Model of Employment and Unemployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rational_expectations.html">
   60. Rational Expectations Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="re_with_feedback.html">
   61. Stability in Linear Rational Expectations Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="markov_perf.html">
   62. Markov Perfect Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="uncertainty_traps.html">
   63. Uncertainty Traps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="aiyagari.html">
   64. The Aiyagari Model
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Asset Pricing and Finance
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="markov_asset.html">
   65. Asset Pricing: Finite State Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ge_arrow.html">
   66. Competitive Equilibria with Arrow Securities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="harrison_kreps.html">
   67. Heterogeneous Beliefs and Bubbles
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data and Empirics
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="pandas_panel.html">
   68. Pandas for Panel Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ols.html">
   69. Linear Regression in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mle.html">
   70. Maximum Likelihood Estimation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Auctions
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="two_auctions.html">
   71. First-Price and Second-Price Auctions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="house_auction.html">
   72. Multiple Good Allocation Mechanisms
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   73. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   74. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="status.html">
   75. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                    <!-- <li class="btn__search">
                        <form action="search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off">
                            <i data-feather="search"></i>
                        </form>
                    </li> -->
                </ul>

                <ul class="qe-toolbar__links">
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="_notebooks/multivariate_normal.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python.myst/tree/master/lectures/multivariate_normal.md" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="_pdf/quantecon-python.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://mybinder.org/v2/gh/QuantEcon/lecture-python.notebooks/master?urlpath=tree/multivariate_normal.ipynb">BinderHub</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-python.notebooks" data-urlpath="tree/lecture-python.notebooks/multivariate_normal.ipynb" data-branch=master>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://mybinder.org/v2/gh/QuantEcon/lecture-python.notebooks/master?urlpath=tree/multivariate_normal.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "multivariate_normal";
                const repoURL = "https://github.com/QuantEcon/lecture-python.notebooks";
                const urlPath = "tree/lecture-python.notebooks/multivariate_normal.ipynb";
                const branch = "master"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/jupyter/hub/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-54984338-10', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>